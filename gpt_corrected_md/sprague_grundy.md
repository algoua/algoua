# Теорія Шпренгера-Гранді. Ними

## Введение

Теорія Шпрага-Гранді - це теорія, що описує так звані **рівноправні** (укр. "імпарціальні") гри двох гравців, тобто гри, в яких дозволені ходи і виграшність/програшність залежать тільки від стану гри. Від того, який саме з двох гравців робить хід, нічого не залежить: тобто гравці повністю рівноправні.

Крім того, передбачається, що гравці розполагають усією інформацією (про правила гри, можливі ходи, положення суперника).

Передбачається, що гра є **кінцевою**, тобто при будь-якій стратегії гравці рано або пізно потраплять у **програшну** позицію, з якої немає переходів в інші позиції. Ця позиція є програшною для гравця, який повинен зробити хід з цієї позиції. Відповідно, вона є виграшною для гравця, який прийшов у цю позицію. Зрозуміло, нічийних результатів в такій грі не буває.

Іншими словами, таку гру можна повністю описати **орієнтованим ациклічним графом**: вершинами в ньому є стан гри, а ребрами - переходи з одного стану гри в інший в результаті ходу поточного гравця (повторимося, обидва гравці рівноправні). Одна або кілька вершин не мають вихідних ребер, вони є програшними вершинами (для гравця, який повинен здійснювати хід з такої вершини).

Оскільки нічийних варіантів не буває, то всі стани гри розпадаються на два класи: **виграшні та програшні**. Виграшні - це такі стани, що існує хід поточного гравця, який приведе до неминучого поразки іншого гравця навіть при його оптимальній грі. Відповідно, програшні стани - це стани, з яких всі переходи ведуть до стану, що призводить до перемоги іншого гравця, незалежно від "опору" першого гравця. Іншими словами, виграшним буде стан, з якого є хоча б один перехід в програшний стан, а програшним є стан, з якого всі переходи ведуть в виграшні стани (або з якого взагалі немає переходів).

Нашою задачею є класифікація станів будь-якої заданої гри, тобто визначення для кожного стану, чи є він виграшним чи програшним.

Теорію таких ігор незалежно розробили Роланд Шпраг (Roland Sprague) у 1935 р. і Патрік Майкл Гранді (Patrick Michael Grundy) у 1939 р.

## Гра "Ним"

Ця гра є одним з прикладів описаних вище ігор. Більше того, як ми побачимо трохи пізніше, **будь-яка** з рівноправних ігор двох гравців насправді еквівалентна грі "нім" (англ. "nim"), тому вивчення цієї гри автоматично дозволить нам розв'язувати всі інші ігри (про це пізніше).

Історично, ця гра була популярна ще в давнину. Ймовірно, гра має своє походження в Китаї - принаймні, китайська гра "Jianshizi" дуже схожа на неї. В Європі перші згадки про цю гру датуються XVI ст. Саме назву "нім" придумав математик Чарльз Бутон (Charles Bouton), який у 1901 р. опублікував повний аналіз цієї гри. Походження назви "нім" досі залишається невідомим.

### Опис гри

Гра "ним" представляє собою наступну гру.

Є декілька купок, в кожній з яких є кілька каменів. За один хід гравець може взяти з будь-якої купки будь-яку кількість каменів, яка не дорівнює нулю, і викинути їх. Відповідно, програш настає, коли ходів більше не залишилося, тобто всі купки порожні.

Отже, стан гри "ним" однозначно описується невпорядкованим набором натуральних чисел. За один хід дозволяється строго зменшити будь-яке з чисел (якщо в результаті число стане нулем, то воно видаляється з набору).

### Розв'язок невірний

Розв'язок цієї гри був опублікований у 1901 році Чарлзом Бутоном (Charles L. Bouton) і виглядає воно наступним чином.

**Теорема**. Поточний гравець має виграшну стратегію тоді і тільки тоді, коли XOR-сума розмірів купок відрізняється від нуля. У протилежному випадку поточний гравець знаходиться в програшному стані. (XOR-сумою чисел $a_i$ називається вираз $a_1 \oplus a_2 \oplus \ldots \oplus a_n$, де $\oplus$ - операція побітового виключаючого або)

**Доведення**.

Основна суть наведеного нижче доведення полягає у наявності **симетричної стратегії для опонента**. Ми доведемо, що, опинившись у стані з нульовою XOR-сумою, гравець не зможе вийти з цього стану - при будь-якому його переході в стан з ненульовою XOR-сумою у опонента знайдеться відповідна відповідь, що поверне XOR-суму назад до нуля.

Приступимо тепер до формального доведення (воно буде конструктивним, тобто ми покажемо, як саме виглядає симетрична стратегія опонента - який саме хід потрібно буде йому здійснювати).

Доведемо теорему за допомогою математичної індукції.

Для порожнього нульового (коли розміри всіх купок рівні нулю) XOR-сума дорівнює нулю, і теорема вірна.

Нехай тепер ми хочемо довести теорему для певного стану гри, з якого є хоча б один перехід. Користуючись припущенням індукції (і ациклічністю гри), ми припустимо, що теорема доведена для всіх станів, в які ми можемо потрапити з поточного.

Значить, доведення розпадається на дві частини: якщо XOR-сума $s$ в поточному стані $=0$, то поточний стан є програшним, тобто всі переходи з нього ведуть в стан з XOR-сумою $t \ne 0$. Якщо ж $s \ne 0$, то потрібно довести, що існує перехід, який приведе нас в стан з $t = 0$.

* Нехай $s = 0$, тоді ми хочемо довести, що поточний стан є програшним. Розглянемо будь-який перехід з поточного стану. Позначимо через $p$ номер купки, яку ми збираємося змінити, через $x_i$ ($i = 1 \ldots n$) - розміри купок до ходу, а через $y_i$ ($i = 1 \ldots n$) - після ходу. За елементарними властивостями операції $\oplus$ маємо:

$$
t = s \oplus x_p \oplus y_p = 0 \oplus x_p \oplus y_p = x_p \oplus y_p.
$$

Але оскільки $y_p < x_p$, то це означає, що $t \ne 0$. Значить, новий стан матиме ненульову XOR-суму, тобто, згідно бази індукції, буде виграшним, що і потрібно довести.

* Нехай $s \neq 0$. Значить, наша задача полягає у доведенні того, що поточний стан є виграшним, тобто з нього існує хід у програшний стан (з нульовою XOR-сумою).

Розглянемо бінарний запис числа $s$. Візьмемо найстарший ненульовий розряд, нехай його номер дорівнює $d$. Нехай $k$ - номер тієї групи, розмір $x_k$ якої $d$-ий розряд відмінний від нуля (такий $k$ знайдеться, інакше в XOR-сумі $s$ цей розряд не вийшов би відмінним від нуля).

Значить, затверджується, що шуканий хід - це змінити $k$-ту купку, зробивши її розміру $y_k = x_k \oplus s$.

Переконаймося в цьому.

Спочатку потрібно перевірити, чи є цей хід коректним, тобто чи виконується умова $y_k < x_k$. Однак це вірно, оскільки всі біти, починаючи з $d$-го, у $x_k$ і $y_k$ співпадають, а в $d$-ому біті у $y_k$ буде нуль, а у $x_k$ - одиниця.

Тепер порахуємо, яка буде XOR-сума під час цього:

$$
t = s \oplus x_k \oplus y_k = s \oplus x_k \oplus (s \oplus x_k) = 0.
$$

Таким чином, зазначений нами хід є насправді програшним, що свідчить про те, що поточний стан є виграшним.

Теорема доведена.

Слідство: будь-який стан гри можна замінити еквівалентним станом, що складається з єдиної купки розміру, рівного XOR-сумі розмірів купок у старому стані.

Іншими словами, при аналізі німи з декількома купками можна порахувати XOR-суму $s$ їх розмірів і перейти до аналізу німи з єдиною купкою розміру $s$. Як показує тільки що доведена теорема, виграшність/програшність не зміниться. Російське слово "німа" слід замінити на українське "гра".

## Еквівалентність будь-якої гри німу. Теорема Шпрага-Гранді

Тут ми покажемо, як будь-яку гру (рівноправну гру двох гравців) поставити у відповідність з нею. Іншими словами, будь-який стан будь-якої гри ми навчимося ставити у відповідність з ним-купкою, яка повністю описує стан вихідної гри.

### Лема про аніме зі збільшеннями

Доведемо спочатку дуже важну лему - **лему про послідовність зростання в аніме**.

А саме, розглянемо наступне, модифіковане ним: все так само, як і в звичайному аніме, проте тепер дозволяється додатковий вид ходу: замість зменшення розміру деякої купки, навпаки, **збільшення**. Щоб бути більш точним, хід гравця полягає в тому, що він або забирає ненульову кількість каменів з якоїсь купки, або збільшує розмір якоїсь купки (відповідно до певних правил, див. наступний абзац).

Тут важливо розуміти, що правила того, як саме гравець може здійснювати збільшення, нас не цікавлять - однак такі правила все ж повинні бути, щоб наша гра як і раніше була ациклічною. Нижче в розділі "Приклади ігор" розглянуті приклади таких ігор: "сходовий ним", "німбл-2", "поворотні черепахи".

Повторимося, лему буде доведено нами загалом для будь-яких ігор уваги "ним з збільшеннями"; конкретні правила збільшень у доведенні не використовуються.

Формулювання леми: "Гра Нім з збільшеннями еквівалентна звичайній грі Нім, оскільки виграшність/програшність стану визначається за теоремою Бутона згідно з XOR-сумою розмірів купок. Збільшення є безглуздими і не мають сенсу в оптимальній стратегії, оскільки вони не змінюють виграшність/програшність порівняно зі звичайною грою Нім".

**Доведення**.

Ідея доведення, як і в теоремі Буттона, полягає в наявності **симетричної стратегії**. Ми покажемо, що збільшення нічого не змінюють, оскільки після того, як один з гравців скористається збільшенням, інший зможе симетрично відповісти йому.

Насправді, припустимо, що поточний гравець здійснює хід збільшення якоїсь купки. Значить, його суперник зможе просто відповісти йому, зменшивши назад цю купку до старого значення - адже звичайні ходи, як і раніше, можуть використовуватися свободно.

Таким чином, симетричною відповіддю на хід-збільшення буде хід-зменшення назад до попереднього розміру купки. Отже, після такої відповіді гра повернеться до попереднього розміру купки, тобто гравець, що збільшив купку, нічого не виграє. Щодо гри на ациклічності, то рано або пізно ходи-збільшення закінчаться, і поточному гравцеві доведеться зробити хід-зменшення, а це означає, що наявність можливості збільшувати купки не змінює гри взагалі.

### Теорема Шпрага-Гранді про еквівалентності будь-якої гри німу

Перейдемо тепер до головного факту в даній статті - теореми про еквівалентність будь-яких рівноправних ігор двох гравців.

**Теорема Шпрага-Гранді**. Розглянемо будь-який стан $v$ деякої рівноправної гри двох гравців. Нехай з нього є переходи в деякі стани $v_i$ $(i=1 \ldots k)$ (де $k \ge 0$). Стверджується, що стан гри, що відповідає стану $v$, можна поставити у відповідність купі німів деякого розміру $x$ (яка буде повністю описувати стан $v$ нашої гри - тобто ці два стани двох різних ігор будуть еквівалентні). Це число $x$ називається **значенням Шпрага-Гранді** стану $v$.

Більше того, число $x$ можна знаходити наступним рекурсивним чином: порахуємо значення Шпрага-Гранді $x_i$ для кожного переходу $(v,v_i)$, і тоді виконується:

$$
x = {\rm mex} \{ x_1, \ldots, x_k \},
$$

де функція $\operatorname{mex}$ від множини чисел повертає найменше невід'ємне число, яке не зустрічається в цій множині (назва "mex" - це скорочення від "minimum excludant").

Таким чином, ми можемо, стартуючи від вершин без вихідних ребер, поступово **обчислити значення Шпрага-Гранді для всіх станів у нашій грі**. Якщо значення Шпрага-Гранді якогось стану дорівнює нулю, то це стан програшний, інакше - виграшний.

Доведення. Будемо доводити теорему за допомогою методу математичної індукції.

Для вершин, з яких немає жодного переходу, величина $x$ згідно теореми буде дорівнювати $\rm mex$ порожньої множини, тобто $x = 0$. Але насправді стан без переходів є програшним станом, і йому дійсно повинна відповідати нульова купка.

Розглянемо тепер будь-який стан $v$, з якого є переходи. За індукцією ми можемо вважати, що для всіх станів $v_i$, у які ми можемо перейти з поточного стану, значення $x_i$ вже підраховані.

Порахуймо величину $p = {\rm mex} \{ x_1, \ldots, x_k \}$. Значить, згідно визначення функції $\rm mex$, ми отримуємо, що для будь-якого числа $i$ в проміжку $[0, p)$ знайдеться хоча б один відповідний перехід у якийсь зі станів з номером $v_i$. Крім того, можуть існувати також додаткові переходи - у стан зі значеннями Гранді, що є більшими за $p$.

Це означає, що поточний стан є еквівалентним стану без купки зі збільшенням розміру $p$. Фактично, існують переходи з поточного стану до стану з купками всіх менших розмірів, а також можуть бути переходи до стану з великими розмірами.

Отже, величина ${\rm mex} \{ x_1, \ldots, x_k \}$ є шуканим значенням Шпрага-Гранді для поточного стану, що потрібно довести.

## Застосування теореми Шпернгера-Гранді

Опишемо нарешті цілісний алгоритм, застосовний до будь-якої рівноправної гри двох гравців для визначення виграшності/програшності поточного стану $v$.

Функція, яка ставить у відповідність кожному стану гри число, називається **функцією Шпрага-Гран

Отже, щоб порахувати функцію Шпрага-Гранді для поточного стану деякої гри, потрібно:

* Виписати всі можливі переходи з поточного стану.

* Кожен такий перехід можна вести або до однієї гри, або до **суми незалежних ігор**.

У першому випадку ми просто рекурсивно порахуємо функцію Гранді для цього нового стану.

У іншому випадку, коли перехід з поточного стану призводить до суми кількох незалежних ігор, рекурсивно порахуємо для кожної з цих ігор функцію Гранді, а потім скажемо, що функція Гранді суми ігор дорівнює XOR-сумі значень цих ігор.

* Після того, як ми порахували функцію Гранді для кожного можливого переходу - припустимо $\mathrm{mex}$ від цих значень, і знайдене число - це шукане значення Гранді для поточного стану.

* Якщо отримане значення Гранді дорівнює нулю, то поточний стан є програшним, інакше - виграшним.

Таким чином, порівняно з теоремою Шпрага-Гранді, тут ми враховуємо можливість переходів з окремих станів до **суми кількох ігор**. Щоб працювати з сумами ігор, спочатку замінюємо кожну гру її значенням Гранді, тобто однією ним-купкою деякого розміру. Після цього ми отримуємо суму кількох ним-купок, тобто звичайний нім, відповідь для якого, згідно з теоремою Бутона, є XOR-сума розмірів купок.

## Закономірності в значеннях Шпрага-Гранді

Дуже часто при вирішенні конкретних задач, коли потрібно навчитися рахувати функцію Шпрага-Гранді для заданої гри, допомагає **вивчення таблиці значень** цієї функції у пошуках закономірностей.

У багатьох іграх, що здаються дуже складними для теоретичного аналізу, функція Шпрага-Гранді на практиці виявляється періодичною або має дуже простий вигляд, який легко помітити "на очі". У переважній більшості випадків помічені закономірності є вірними і, за бажанням, можуть бути доведені за допомогою математичної індукції.

Проте, не завжди функція Шпрага-Гранді містить прості закономірності, а для деяких, навіть дуже простих за формулюванням, ігор питання про наявність таких закономірностей до цього часу залишається відкритим (наприклад, "Гру Гранді" нижче).

## Приклади ігор

Для наочної демонстрації теорії Шпрага-Гранді розглянемо кілька задач.

Особливо варто звернути увагу на завдання "сходовий ним", "розумний-2", "поворотні черепахи", в яких демонструється нетривіальне зведення вихідної задачі до гри "нім" зі збільшеннями.

### "Хрестики-хрестики"

**Умова**. Розглянемо клітинчасту стрічку розміру $1 \times n$. За один хід гравець повинен поставити один хрестик, але заборонено ставити два хрестики поруч (в сусідні клітинки). Програє той, хто не може зробити хід. Визначити, хто переможе при оптимальній

**Розв'язок**. Коли гравець ставить хрестик у будь-яку клітинку, можна вважати, що вся лінія розпадається на дві незалежні половинки: ліворуч від хрестика і праворуч від нього. При цьому сама клітина з хрестиком, а також її лівий і правий сусіди знищуються - тобто в них більше не можна буде поставити жодного знаку.

Отже, якщо ми занумеруємо клітини смужки від $0$ до $n-1$, то, поставивши хрестик в позицію $1 \leq i \leq n-2$, смужка розпадеться на дві смужки довжини $i-1$ і $n-i-2$, тобто ми перейдемо до суми двох ігор $i-1$ і $n-i-2$. Якщо ж хрестик ставиться в позицію $0$ або $n-1$, то це особливий випадок - ми просто перейдемо до стану $n-2$.

Таким чином, функція Гранді $g[n]$ має вигляд (для $n \ge 3$):

$$
g[n] = {\rm mex} \Bigg\{ g[n-2], \bigcup_{i=2}^{n-1} \Big( g[i-2] \oplus g[n-i-1] \Big) \Bigg\}.
$$

тобто, $g[n]$ дорівнює $\rm mex$ множини, яка складається з числа $g[n-2]$, а також всіх можливих значень виразу $g[i-2] \oplus g[n-i-1]$.

Отже, ми отримали розв'язок цієї задачі за $O(n^2)$.

Насправді, як лінгвіст з української мови, вважаючи на комп'ютері таблицю значень для першої сотні значень $n$, можна побачити, що, починаючи з $n=52$, послідовність $g[n]$ стає періодичною з періодом $34$. Ця закономірність зберігається і далі (що, ймовірно, можна довести за допомогою індукції).

### "Хрестики-хрестики - 2"

Умова. Знову гра ведеться на стрічці $1 \times n$ клітин, і гравці по черзі ставлять по одному крестика. Виграє той, хто поставить три крестика поспіль.

**Розв'язок**. Зауважимо, що якщо $n>2$ і ми залишили після свого ходу два хрестики поруч або через один пробіл, то противник наступним ходом переможе. Отже, якщо один гравець поставив десь хрестик, то іншому гравцеві не вигідно ставити хрестик в сусідні клітини з ним, а також в сусідні з сусідніми (тобто на відстані $1$ і $2$ ставити не вигідно, це призведе до поразки).

Значить, розв'язок виходить практично аналогічним попередній задачі, тільки тепер хрестик видаляє у кожній половинці не одну, а зразу дві клітинки.

### "Пешки"

**Умова**. Є поле $3 \times n$, на якому в першому і третьому ряду стоять по $n$ пішаків - білих і чорних, відповідно. Перший гравець ходить білими пішаками, другий - чорними. Правила ходу і удару - стандартні шахові, за винятком того, що бити (при наявності такої можливості) обов'язково.

**Розв'язок**. Прослідкуємо, що відбувається, коли одна пішак зробить хід вперед. Наступним ходом противник буде зобов'язаний з'їсти її, потім ми будемо зобов'язані з'їсти пішака супротивника, потім знову він з'їсть, і, нарешті, наша пішак з'їсть ворожу пішаку і залишиться, "упершись" в пішака супротивника. Таким чином, якщо ми на початку пішли пішаком в колонці $1 < i < n$, то в результаті три колонки $[i-1; i+1]$ дошки фактично знищаться, і ми перейдемо до гри розміру $i-2$ і $n - i - 1$. Граничні випадки $i=1$ і $i=n$ приведуть нас просто до дошки розміру $n-2$.

Таким чином, ми отримали вираз для функції Гранді, аналогічний розглянутій вище задачі "Хрестики-нулики".

### "Lasker's nim"

**Умова**. Є $n$ купок каменів заданих розмірів. За один хід гравець може взяти будь-яке ненульове число каменів з будь-якої купки, або розділити будь-яку купку на дві непусті купки. Програє той, хто не може зробити хід.

**Розв'язок**. Записуючи обидва уваги переходів, легко отримати функцію Шпрага-Гранді як:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-1} g[i], ~~ \bigcup_{i=1}^{n-1} \Big( g[i] \oplus g[n-i] \Big) \Bigg\}.
$$

Однак можна побудувати таблицю значень для малих $n$ і побачити просту закономірність:

$$
\matrix{
n & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 & 13 & 14 & 15 & 16 & 17 & 18 & 19 \cr
g[n] & 0 & 1 & 2 & 4 & 3 & 5 & 6 & 8 & 7 & 9 & 10 & 12 & 11 & 13 & 14 & 16 & 15 & 17 & 18 & 20 \cr
}
$$

Тут видно, що $g[n] = n$ для чисел, що дорівнюють $1$ або $2$ за модулем $4$, і $g[n] = n \pm 1$ для чисел, що дорівнюють $3$ або $0$ за модулем $4$. Довести це можна за допомогою індукції.

### "The game of Kayles"

Умова. Є $n$ кеглів, розставлених в ряд. За один удар гравець може вибити або одну кеглю, або дві поруч стоячі кеглі. Перемагає той, хто вибив останню кеглю.

Розв'язок. Якщо гравець вибиває одну кеглю, або дві кеглі, гра розпадається на суму двох незалежних ігор.

Не складно отримати такий вираз для функції Шпрага-Гранді:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-1} \Big( g[i] \oplus g[n-1-i] \Big), ~~ \bigcup_{i=0}^{n-2} \Big( g[i] \oplus g[n-2-i] \Big) \Bigg\}.
$$

Порахуємо таблицю для кількох перших десятків елементів:

$$
\matrix{
g[0 \ldots 11]: & 0 & 1 & 2 & 3 & 1 & 4 & 3 & 2 & 1 & 4 & 2 & 6 \cr
g[12 \ldots 23]: & 4 & 1 & 2 & 7 & 1 & 4 & 3 & 2 & 1 & 4 & 6 & 7 \cr
g[24 \ldots 35]: & 4 & 1 & 2 & 8 & 5 & 4 & 7 & 2 & 1 & 8 & 6 & 7 \cr
g[36 \ldots 47]: & 4 & 1 & 2 & 3 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[48 \ldots 59]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 4 & 2 & 7 \cr
g[60 \ldots 71]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 6 & 7 \cr
g[72 \ldots 83]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[84 \ldots 95]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[96 \ldots 107]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[108 \ldots 119]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
}
$$

Можна помітити, що з деякого моменту послідовність стає періодичною з періодом $12$. В подальшому ця періодичність також не порушується.

### Grundy's game

**Умова**. Є $n$ купок каменів, розміри яких ми позначимо як $a_i$. За один хід гравець може взяти яку-небудь купку розміру не менше $3$ і розділити її на дві непусті купки нерівних розмірів. Програє той, хто не може зробити хід (тобто коли розміри всіх залишених купок менші або рівні двом).

**Розв'язок**. Якщо $n > 1$, то всі ці купки, очевидно, є незалежними грами. Отже, наша задача - навчитися знаходити функцію Шпрага-Гранді для однієї купки, а відповідь для декількох купок буде визначатися як їх XOR-сума.

Для однієї купки цю функцію можна побудувати також легко, досить переглянути всі можливі переходи:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=[1 \ldots n-1], \atop i \ne n-i } \Big( g[i] \oplus g[n-i] \Big) \Bigg\}.
$$

Чим ця гра цікава? Тим, що до цього часу не було знайдено загального закону для неї. Незважаючи на припущення, що послідовність $g[n]$ має бути періодичною, її було обчислено аж до $2^{35}$, але періодів в цьому діапазоні не було виявлено.

### "Лестничный ним"

**Умова**. Є драбина з $n$ сходинок (позначених числами від $1$ до $n$), на $i$-ій з них лежить $a_i$ монет. За один крок дозволяється перемістити деяку ненульову кількість монет з $i$-ої сходинки на $(i-1)$-у. Програє той, хто не може зробити хіду.

**Розв'язок**. Якщо спробувати звести цю задачу до німого "в лоб", то вийде, що хід у нас - це зменшення однієї купки на певну кількість, і одночасне збільшення іншої купки на ту саму кількість. В результаті ми отримуємо модифікацію німа, розв'язати яку вельми складно.

Поступимо інакше: розглянемо лише ступені з парними номерами: $a_2, a_4, a_6, \dots$. Подивимося, як змінюватиметься цей набір чисел після виконання одного кроку.

Якщо хід робиться з парним $i$, то цей хід означає зменшення числа $a_i$. Якщо ж хід робиться з непарним $i$ ($i > 1$), то це означає збільшення $a_{i-1}$.

Отримується, що наша задача - це звичайний нім з збільшеннями розмірів купок $a_2, a_4, a_6, \ldots$.

Отже, функція Гранді для нього - це XOR-сума чисел увазі $a_{2i}$.

### "Nimble" і "Nimble-2"

**Умова**. Є смужка розміром $1 \times n$, на якій розташовані $k$ монет: $i$-та монета знаходиться в $a_i$-ій клітинці. За один хід гравець може взяти якусь монету і зсунути її вліво на довільне число клітинок, але так, щоб вона не випала за межі смужки. У грі "Nimble-2" додатково заборонено перескакувати через інші монети (або навіть ставити дві монети в одну клітинку). Програє той, хто не може зробити хід.

**Розв'язок "Nimble"**. Зауважимо, що монети в цій грі незалежні один від одного. Більше того, якщо ми розглянемо набір чисел $a_i-1$ $(i = 1 \ldots k)$, то зрозуміло, що за один хід гравець може взяти будь-яке з цих чисел і зменшити його, а програш настає, коли всі числа стають нулем. Отже, гра "Nimble" - це **звичайний нім**, і відповіддю на задачу є XOR-сума чисел $a_i-1$.

**Розв'язок "Nimble-2"**. Перенумеруємо монети в порядку їх слідування зліва направо. Отже, позначимо через $d_i$ відстань від $i$-ої до $(i-1)$-ої монети:

$$
d_i = a_i - a_{i-1} - 1, (i = 1 \ldots k)
$$

(вважаючи, що $a_0 = 0$).

Отже, за одного гравця можна відняти від будь-якого $d_p$ деяке число $q$ та додати це ж число $q$ до $d_{p+1}$. Таким чином, ця гра фактично є грою в "сходовий ним" над числами $d_i$ (потрібно лише змінити порядок цих чисел на протилежний).

### "Turning turtles" і "Twins"

Умова. Дана смуга з клітинок розміру $1 \times n$. У кожній клітинці може бути або хрестик, або нулик. За один крок можна взяти будь-який нулик і перетворити його на хрестик.

При цьому **додатково** дозволяється вибрати одну з комірок ліворуч від змінної і змінити в ній значення на протилежне (тобто нулик замінити на хрестик, а хрестик - на нулик). У грі "Turning Turtles" робити це не обов'язково (тобто хід гравця може обмежуватися перетворенням нулика в хрестик), а в "Twins" - обов'язково.

Розв'язок гри "turning turtles". Стверджується, що ця гра полягає в нумерації чисел $b_i$, де $b_i$ - позиція $i$-го нуля (в 1-індексації). Перевіримо це твердження.

\ul {

* Якщо гравець просто змінив нулик на хрестик, не скориставшись додатковим ходом, то це можна розуміти як те, що він просто забрав всю купку, відповідну цьому нулику. Іншими словами, якщо гравець змінив нулик на хрестик у позиції $x$ $(1 \le x \le n)$, то тим самим він взяв купку розміру $x$ і зробив її розмір рівним нулю.

* Якщо гравець скористався додатковим ходом, тобто крім того, що змінив нулик на хрестик у позиції $x$, він ще змінив клітинку в позиції $y$ $(y < x)$, то можна вважати, що він зменшив купку $x$ до розміру $y$. Дійсно, якщо в позиції $y$ раніше був хрестик, то після ходу гравця там стане нулик, тобто з'явиться купка розміру $y$. А якщо в позиції $y$ раніше був нулик, то після ходу гравця ця купка зникне - або, що те саме, з'явиться друга купка точно такого ж розміру $y$ (оскільки в аніме дві купки однакових розмірів фактично "анулюють" одна одну).

}

Таким чином, відповідь на задачу полягає в XOR-сумі координат всіх нулів у 1-індексації.

**Розв'язок "близнюки"**. Усі розсудження, наведені вище, залишаються вірними, за винятком того, що хід "обнулити купу" тепер недоступний для гравця. Тобто, якщо ми з усіх координат віднімемо одиницю, то гра знову перетвориться на звичайну.

Таким чином, відповідь на задачу полягає у XOR-сумі чисел - координат всіх нулів в 0-індексації.

### Northcott's game

**Умова**. Є дошка розміру $n \times m$: $n$ рядків і $m$ стовпців. У кожному рядку стоїть по дві фішки: одна чорна і одна біла. За один хід гравець може взяти будь-яку фішку свого кольору і перемістити її всередині рядка вправо або вліво на довільну кількість кроків, не перескакуючи через іншу фішку (і не ставлячи її на її шляху). Програє той, хто не може зробити ходу.

Розв'язок. По-перше, зрозуміло, що кожна з $n$ стрічок дошки утворює незалежну гру. Тому задача зводиться до аналізу гри в одній стрічці, а відповіддю на задачу буде XOR-сума значень Шпрага-Гранді для кожної з стрічок.

Розв'язуючи задачу для однієї стрічки, позначимо через $x$ відстань між чорною та білою фішкою (яку можна змінювати від нуля до $m-2$). За один хід кожен гравець може або зменшити $x$ на деяке значення, або, можливо, збільшити його до деякого значення (збільшення доступні не завжди). Таким чином, ця гра - це "нім з збільшеннями", і, як ми вже знаємо, збільшення в цій грі є непотрібними. Отже, функція Гранді для однієї стрічки - це саме відстань $x$.

(Слід зазначити, що формально таке розумування неповне, оскільки в "аніме зі збільшеннями" передбачається, що гра є **кінцевою**, тоді як тут правила гри дозволяють гравцям грати нескінченно довго. Однак, неможливо мати безкінечну гру при оптимальній грі - гравцеві потрібно буде збільшувати відстань $x$ (за ціною наближення до межі поля), коли інший гравець наближається до нього, а іншому гравцеві потрібно буде зменшувати $x$, коли він віддаляється. Таким чином, при оптимальній грі суперника гравцю не вдасться здійснювати збільшення ходів нескінченно довго, тому все описане рішення задачі залишається в силі).

### Триомино

**Умова**. Дано клітинне поле розміру $2 \times n$. За один хід гравець може поставити на поле одну фігурку в формі букви "Г" (тобто зв'язну фігуру з трьох клітин, що не лежать на одній прямій). Заборонено ставити фігурку так, щоб вона перетиналась хоча б однією клітинкою з якоюсь з вже поставлених фігурок. Програє той, хто не може зробити хід.

**Розв'язок**. Зауважимо, що постановка однієї фігурки розбиває все поле на два незалежні поля. Таким чином, нам потрібно аналізувати не лише прямокутні поля, але і поля, у яких ліва і/або права межі нерівні.

Намалювавши різні конфігурації, можна зрозуміти, що незалежно від конфігурації поля, головне - кількість вільних клітин. Якщо в поточному полі є $x$ вільних клітин, і ми хочемо розбити його на два поля розміром $y$ і $z$ (де $y+z+3 = x$), то це завжди можна зробити, тобто завжди можна знайти відповідне місце для фігурки.

Таким чином, наша задача перетворюється на наступну: спочатку ми маємо купу каменів розміру $2n$, і за один хід ми можемо викинути з деякої купки $3$ камені і потім розбити цю купку на дві купки довільних розмірів. Функція Гранді для такої гри має наступний вигляд:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-3} \Big( g[i] \oplus g[n-i-3] \Big) \Bigg\}.
$$

### Крапки на графі

**Умова**. Даний орієнтований ациклічний граф. У деяких вершинах графу розміщені фішки. За один хід гравець може взяти будь-яку фішку і перемістити її вздовж будь-якого ребра до нової вершини. Програє той, хто не може зробити хід.

Також буває і другий варіант цієї задачі: якщо дві фішки потрапляють в одну вершину, то вони взаємно знищують одна одну.

**Розв'язок першого варіанту задачі**. По-перше, всі фішки є незалежними одна від одної, тому наша задача - навчитися знаходити функцію Гранді для однієї фішки в графі.

Враховуючи, що граф аціклічен, ми можемо робити це рекурсивно: припустимо, що ми порахували функцію Гранді для всіх нащадків поточній вершини. Значить функція Гранді в поточній вершині - це $\rm mex$ від цього множини чисел.

Таким чином, розв'язком задачі є наступне: для кожної вершини потрібно рекурсивно порахувати функцію Гранді, якщо фішка стоїть саме в цій вершині. Після цього відповіддю на задачу буде XOR-сума значень Гранді від тих вершин графа, в яких за умовою стоять фішки.

**Розв'язок іншої варіації задачі**. Насправді, друга варіація задачі не відрізняється від першої. Якщо дві фішки стоять в одній і тій же вершині графа, то в результуючій XOR-сумі їх значення Гранді взаємно знищують одне одного. Отже, це фактично одна й та ж задача.

## Реалізація

З позиції реалізації інтересу можна розглядати реалізацію функції $\rm mex$.

Якщо це не є головним обмеженням у програмі, то можна написати який-небудь простий алгоритм з складністю $O(c \log c)$ (де $c$ - кількість аргументів):

<!--- TODO: specify code snippet id -->
``` cpp
int mex(vector<int> a) {
    set<int> b(a.begin(), a.end());
    for (int i = 0;; ++i)
        if (!b.count(i))
            return i;
}
```

Втім, різновид **за лінійний час**, тобто $O(c)$, де $c$ - число аргументів функції $\rm mex$, не є настільки складним. Позначимо через $D$ константу, рівну максимально можливому значенню $c$ (тобто максимальній степені вершини в графі гри). У такому випадку результат функції $\rm mex$ не буде перевищувати $D$.

Отже, при реалізації необхідно завести масив розміру $D+1$ (масив глобальний, або статичний - головне, щоб він не створювався при кожному виклику функції). При виклику функції $\rm mex$ ми спочатку відзначимо в цьому масиві всі $c$ аргументів (пропустивши ті з них, які більше $D$ - такі значення, очевидно, не впливають на результат). Потім проходом по цьому масиву ми за $O(D)$ знайдемо перший неотмічений елемент. Нарешті, в кінці можна знову пройтися по всім переданим аргументам і обнулити масив для них. Тим самим, ми виконаємо всі дії за $O(c+D)$, що на практиці може виявитися істотно меншим за максимальну степінь $D$.

<!--- TODO: specify code snippet id -->
``` cpp
int mex(const vector<int> &a) {
    static bool used[D + 1] = {0};
    int c = (int)a.size();

    for (int i = 0; i < c; ++i)
        if (a[i] <= D)
            used[a[i]] = true;

    int result;
    for (int i = 0;; ++i)
        if (!used[i]) {
            result = i;
            2 break;
        }

    for (int 1 i = 0; i < c; ++i)
        if (a[i] <= D)
            used[a[i]] = false;

    return result;
}
```

Інший різновид - скористатися технікою **"числового використання"**. Тобто зробити $\rm used$ масивом не булевих змінних, а чисел ("версій"), і завести глобальну змінну, яка позначає номер поточної версії. При вході в функцію $\rm mex$ ми збільшуємо номер поточної версії, в першому циклі ми проставляємо в масиві $\rm used$ не $\rm true$, а номер поточної версії. Нарешті, у другому циклі ми просто порівнюємо ${\rm used}[i]$ з номером поточної версії - якщо вони не збіглися, то це означає, що поточне число не зустрічалося в масиві $a$. Третій цикл (який раніше зануляв масив $\rm used$) в такому рішенні не потрібен.

## Узагальнення німа: ним Мура ($k$-ним)

Одне з цікавих узагальнень звичайного числа було запропоновано Муром (Moore) у 1910 році.

**Умова**. Є $n$ купок каменів розміру $a_i$. Також задано натуральне число $k$. За один хід гравець може зменшити розмір від однієї до $k$ купок (тобто тепер дозволяються одночасні ходи в декількох купках одночасно). Програє той, хто не може зробити ходу.

Очевидно, при $k=1$ найменування Мура перетворюється на звичайне найменування.

**Розв'язок**. Розв'язок такої задачі дивовижно простий. Запишемо розміри кожної купки у двійковій системі числення. Потім підсумуємо ці числа у $(k+1)$-ичній системі числення без переносів розрядів. Якщо вийшло число нуль, то поточна позиція програшна, інакше - виграшна (і є хід у позицію з нульовим значенням).

Іншими словами, для кожного біту ми перевіряємо, чи варто включати цей біт у двійковому представленні кожного числа $a_i$. Потім ми додаємо отримані значення нуль/один та беремо за модулем $k+1$. Якщо сума для кожного біту дорівнює нулю, то поточна позиція є програшною, в іншому випадку - виграшною. Також слід замінити російське слово "підсумок" на українське "сума".

**Доведення**. Як і для німої гри, доведення полягає в описі стратегій гравців: з одного боку, ми показуємо, що з гри з нульовим значенням ми можемо перейти тільки в гру з ненульовим значенням, а з іншого боку - що з гри з ненульовим значенням є хід в гру з нульовим значенням.

По-перше, покажемо, що з гри з нульовим значенням можна перейти тільки до гри з ненульовим значенням. Це цілком зрозуміло: якщо сума за модулем $k+1$ була рівна нулю, то після зміни від одного до $k$ біт ми не зможемо знову отримати нульову суму.

По-друге, покажемо, як з гри з ненульовою сумою перейти в гру з нульовою сумою. Будемо перебирати біти, в яких сума вийшла ненульовою, в порядку від старшого до молодшого.

Позначимо через $u$ кількість купок, які ми вже почали змінювати; спочатку $u = 0$. Звернемо увагу, що в цих $u$ купках ми вже можемо ставити будь-які біти на наш розсуд (оскільки в будь-якій купці, яка потрапила до числа цих $u$ купок, вже зменшився один з попередніх, більш старих, бітів).

Отже, нехай ми розглядаємо поточний біт, в якому сума за модулем $k+1$ вийшла ненульовою. Позначимо через $s$ цю суму, але без урахування тих $u$ купок, які ми вже почали змінювати. Позначимо через $q$ суму, яку можна отримати, поставивши в ці $u$ купок поточний біт рівним одиниці:

$$
q = (s + u) \pmod{(k+1)}
$$

У нас є два варіанти:

* Якщо $q \le u$.

Значить, ми можемо обійтися лише вже обраними $u$ купками: достатньо в $k+1-s = u-q$ з них поставити поточний біт рівним одиниці, а в усіх інших - рівним нулю.

* Якщо $q > u$.

У такому випадку ми, навпаки, поставимо в уже обраних $u$ купках поточний біт рівним нулю. Значить, сума в поточному біті буде рівна $s > 0$, а, отже, серед невибраних $n-u$ купок в поточному біті є як мінімум $s$ одиниць. Виберемо будь-які $s$ купок серед них і зменшимо в них поточний біт з одиниці до нуля.

У результаті кількість $u$ змінюваних купок збільшиться на $s$ і становитиме $q$, яке не перевищує $k$.

Таким чином, ми показали, як вибирати множину змінних куп і які біти в них потрібно змінювати, щоб загальна кількість $u$ ніколи не перевищувала $k$.

Отже, ми довели, що шуканий перехід зі стану з ненульовою сумою в стан з нульовою сумою існує, що й потрібно було довести.

## "Ним піддавання"

Той нім, який ми розглядали у всій цій статті, називається також "нормальним німом". На відміну від нього, існує також "нім в піддавання" ("мізерний нім"), коли гравець, що зробив останній хід, програє, а не перемагає.

До речі, на всю видимість, ця настільна гра є більш популярною саме у версії "в піддавання", а не в "нормальній" версії

Розв'язок такого німа дивовижно простий: будемо діяти так само, як і в звичайній грі "нім" (тобто порахуємо XOR-суму всіх розмірів купок, і якщо вона дорівнює нулю, то ми програємо при будь-якій стратегії, а інакше - виграємо, знайшовши перехід в позицію з нульовим значенням Шпрага-Гранді). Але є один **виняток**: якщо розміри всіх купок дорівнюють одиниці, то виграшність/програшність міняються місцями порівняно зі звичайним "німом".

Таким чином, виграшність/програшність "в піддавання" визначається за кількістю:

$$
a_1 \oplus a_2 \oplus \ldots \oplus a_n \oplus z,
$$

де через $z$ позначена булева змінна, рівна одиниці, якщо $a_1 = a_2 = \ldots = a_n = 1$.

З урахуванням цього винятку, **оптимальна стратегія** для гравця у виграшній позиції визначається наступним чином. Знайдемо хід, який гравець здійснив би, якщо він грав у звичайному режимі. Тепер, якщо цей хід призводить до позиції, в якій розміри всіх купок дорівнюють одиниці (і до цього ходу була купка розміру більше одиниці), то цей хід потрібно змінити: змінити так, щоб кількість залишених непорожніх купок змінилася на парну.

Доведення. Звернімо увагу, що загалом теорія Шпрага-Гранді відноситься до "нормальних" ігор, а не до ігор у піддавання. Однак ця гра є однією з тих ігор, для яких розв'язок гри "у піддавання" не сильно відрізняється від розв'язку "нормальної" гри. (До речі, розв'язок гри "у піддавання" було дано тим же Чарлзом Бутоном, який описав розв'язок "нормальної" гри).

Як можна пояснити таку дивну закономірність: що виграшність/програшність "в піддавання" збігається з виграшністю/програшністю "нормального" німа майже завжди?

Розглянемо деяке **течію гри**: тобто виберемо довільну стартову позицію і випишемо ходи гравців аж до завершення гри. Не складно зрозуміти, що за умови оптимальної гри супротивників гра завершиться тим, що залишиться одна купка розміру $1$, і гравець буде змушений піти в ній і програти.

Отже, у будь-якій грі двох оптимальних гравців рано або пізно настає момент, коли розміри всіх непустих купок рівні одиниці. Позначимо через $k$ число непустих купок в цей момент. Тоді для поточного гравця ця позиція є виграшною тоді і лише тоді, коли $k$ парне. Тобто ми переконалися в тому, що в таких випадках виграшність/програшність у німій грі "віддачі" протилежна "звичайній" німій грі.

Знову повернемося до того моменту, коли вперше в грі всі купки стали розміру $1$, і повернемося на один хід назад - прямо перед тим, як ця ситуація вийшла. Ми опинилися в ситуації, що одна купка має розмір $>1$, а всі інші купки (можливо, їх було нуль штук) - розміру $1$. Ця позиція очевидно виграшна (т.до. ми насправді завжди можемо зробити такий хід, щоб залишалося непарне число купок розміру $1$, тобто наведемо суперника до ураження). З іншої сторони, XOR-сума розмірів купок в цей момент відмінна від нуля - значить, тут "нормальний" німець збігається з німцем "в піддавання".

Далі, якщо ми продовжимо відкатуватися по грі назад, то ми будемо приходити до стану, коли в грі було дві купки розміру $>1$, три купки тощо. Для всіх таких станів виграшність/програшність також буде збігатися з "нормальним" німом, просто тому, що коли у нас є більше однієї купки розміру $>1$, то всі переходи ведуть до стану з однією або більше купкою розміру $>1$. Для всіх таких станів, як ми вже показали, нічого не змінилося порівняно з "нормальним" німом.

Таким чином, зміни в аніме "У підданстві" затримали тільки той стан, коли всі купки мають розмір, рівний одиниці - що й потрібно довести.

## Завдання на онлайн-суддях

Список задач в online judges, які можна розв'язувати з допомогою функції Гранді:

* [TIMUS #1465 **"Гра в пішки"** [складність: низька]](http://acm.timus.com/problem.aspx?space=1&num=1465)

* [UVA #11534 **"Say Goodbye to Tic-Tac-Toe"** [складність: середня]](http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=2529)

## Література

* \book{John Horton Conway}{On numbers and games}{1979}{conway.djvu}
* [Bernhard von Stengel. **Lecture Notes on Game Theory**](http://jourdan.ens.fr/~laffargue/teaching/Incertain/Problemes/lectnotes.pdf)