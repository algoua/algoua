# Короткі шляхи фіксованої довжини, кількість шляхів фіксованої довжини

Нижче описуються розв'язки цих двох задач, побудовані на одній і тій же ідеї: зведення задачі до піднесення матриці до ступеня (звичайною операцією множення та модифікованою).

## Кількість шляхів фіксованої довжини

Нехай задано орієнтований незважений граф $G$ з $n$ вершинами та ціле число $k$. Для кожної пари вершин $i$ та $j$ потрібно знайти кількість шляхів з $i$ в $j$, що складаються з $k$ ребер. При цьому шляхи можуть бути довільними, не обов'язково простими (тобто вершини можуть повторюватись довільну кількість разів).

Будемо вважати, що граф завдано **матрицею суміжності**, тобто матрицею $g_{n\times n}$, де кожний елемент $g_{i,j}$ рівний одиниці, якщо між цими вершинами є ребро, і нулю, якщо ребра немає. Описаний нижче алгоритм працює і в випадку наявності кратних ребер: якщо між якимись вершинами $i$ і $j$ є зразу $m$ ребер, то в матрицю суміжності випливає записати число $m$. Також алгоритм правильно враховує петлі в графі, якщо такі є.

Очевидно, що у такому вигляді **матриця суміжності** графа є **відповіддю на задачу при $k=1$** - вона містить кількості шляхів довжини $1$ між кожною парою вершин.

Розв'язок будемо будувати **ітеративно**: нехай відповідь для деякого $k$ знайдена, покажемо, як побудувати її для $k+1$. Позначимо через $d_k$ знайдену матрицю відповідей для $k$, а через $d_{k+1}$ - матрицю відповідей, яку необхідно побудувати. Очевидною є наступна формула:

$$
d_{k+1}[i][j] = \sum_{p = 1}^{n} d_k[i][p] \cdot g[p][j].
$$

Легко помітити, що записана вище формула - це не що інше, як добуток двох матриць $d_k$ та $g$ в звичайному сенсі:

$$
d_{k+1} = d_k \cdot g.
$$

Таким чином, розв'язок цієї задачі можна уявити наступним чином:

$$
d_k = \underbrace{ g \cdot \ldots \cdot g}_{k\ {\rm times}} = g^k.
$$

Залишається зазначити, що піднесення матриці до степеня можна провести ефективно за допомогою алгоритму [**Бінарного піднесення до степеня**](binary_pow).

Отже, отриманий розв'язок має асимптотику $O(n^3 \log k)$ і полягає у бінарному піднесенні до $k$-ої степені матриці суміжності графу.

## Найкоротші шляхи фіксованої довжини

Нехай задано орієнтований зважений граф $G$ з $n$ вершинами, та ціле число $k$. Для кожної пари вершин $i$ та $j$ потрібно знайти довжину найкоротшого шляху між ними, що складається з $k$ ребер.

Будемо вважати, що граф завдано **матрицею суміжності**, тобто матрицею $g_{n \times n}$, де кожний елемент $g_{i,j}$ містить довжину ребра з вершини $i$ в вершину $j$. Якщо між якимись вершинами ребра немає, то відповідний елемент матриці припустимо рівним нескінченності $\infty$.

Очевидно, що у такому вигляді **матриця суміжності** графа є **відповіддю на задачу при $k=1$** - вона містить довжини найкоротших шляхів між кожною парою вершин, або значення $\infty$, якщо шляхи довжини $1$ не існує.

Розв'язок будемо будувати **ітеративно**: нехай відповідь для деякого $k$ знайдена, покажемо, як побудувати її для $k+1$. Позначимо через $d_k$ знайдену матрицю відповідей для $k$, а через $d_{k+1}$ - матрицю відповідей, яку необхідно побудувати. Очевидна наступна формула:

$$
d_{k+1}[i][j] = \min_{p = 1 \ldots n} ( d_k[i][p] + g[p][j] ).
$$

Уважно розглянувши цю формулу, легко провести аналогію з матричним множенням: фактично, матриця $d_k$ множиться на матрицю $g$, лише в операції множення замість суми по всіх $p$ береться мінімум по всіх $p$:

$$
d_{k+1} = d_k \odot g,
$$

де операція $\odot$ множення двох матриць визначається наступним чином:

$$
A \odot B = C \ \ \Longleftrightarrow\ \  C_{ij} = \min_{p=1 \ldots n} (A_{ip} + B_{pj}).
$$

Таким чином, розв'язок цієї задачі можна уявити за допомогою операції множення наступним чином:

$$
d_k = \underbrace{ g \odot \ldots \odot g}_{k\ {\rm times}} = g^{\odot k}.
$$

Залишається зазначити, що піднесення до степеня за допомогою операції множення можна виконати ефективно за допомогою алгоритму [**Бінарного піднесення до степеня**](binary_pow), оскільки єдина необхідна властивість - асоціативність операції множення - є очевидною.

Отже, отриманий розв'язок має асимптотику $O(n^3 \log k)$ і полягає у бінарному піднесенні до $k$-ої степені матриці суміжності графа зі зміненою операцією множення матриць.

## Узагальнення для випадку, коли потрібні шляхи довжиною не більше, ніж задана довжина

Описані вище розв'язки вирішують задачі, коли потрібно розглядати шляхи певної фіксованої довжини. Однак ці ж розв'язки можна адаптувати для вирішення задач, коли потрібно розглядати шляхи, які містять **не більше** заданої кількості ребер.

Це можна зробити, трохи модифікувавши вхідний граф. Наприклад, якщо нас цікавлять тільки шляхи, що закінчуються в певній вершині $t$, то в граф можна **додати петлю** $(t,t)$ нульової ваги.

Якщо ж нас як і раніше цікавлять відповіді для всіх пар вершин, то просте додавання петель до всіх вершин зіпсує відповідь. Замість цього можна **роздвоїти** кожну вершину: для кожної вершини $v$ створити додаткову вершину $v'$, провести ребро $(v,v')$ і додати петлю $(v',v')$.

Розв'язав задачу про пошук шляхів фіксованої довжини на модифікованому графі. Відповіді на початкову задачу будуть представлені як шляхи між вершинами $i$ та $j'$ (тобто додаткові вершини є вершинами-закінченнями, в яких ми можемо "покрутитися" потрібну кількість разів). Російське слово "и" в другому реченні можна замінити на українське "та".