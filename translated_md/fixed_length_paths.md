# Кратчайшие шляхи фіксованою довжини, кількості шляхів фіксованою довжини

Нижче описываются розв'язку цих двох задач, построенные на однієї і тією ж ідеї: зведення задачі до возведению матриці в ступінь (з звичайної операцією множення, і з модифікованій).

## Кількість шляхів фіксованою довжини

Нехай завдань орієнтований незважений граф $G$ з $n$ вершинами, і задано ціле число $k$. Потрібно для кожної пари вершин $i$ і $j$ знайти кількість шляхів між цими вершинами, складаються рівне з $k$ ребер. Пути при цим розглядаються довільні, не обов'язково прості (тобто вершини можуть повторяться скільки завгодно раз).

Будемо вважати, що граф завдань **матрицею суміжності**, тобто матрицею $g[][]$ розміру $n \times n$, де кожний елемент $g[i][j]$ рівний одиниці, якщо між цими вершинами є ребро, і нулю, якщо ребра ні. Описаний нижче алгоритм працює і в випадку наявності кратних ребер: якщо між якимись вершинами $i$ і $j$ є зразу $m$ ребер, то в матрицю суміжності випливає записати це число $m$. Також алгоритм правильно враховує петлі в графі, якщо такі є.

Очевидно, що в такому вигляді **матриця суміжності** графа є **відповіддю на задачу при $k=1$** - вона містить кількості шляхів довжини $1$ між кожної парою вершин.

Розв'язок будемо будувати **ітеративно**: нехай відповідь для деякого $k$ знайдений, покажемо, як побудувати його для $k+1$. Позначимо через $d_k$ знайдену матрицю відповідей для $k$, а через $d_{k+1}$ - матрицю відповідей, яку необхідно побудувати. Значить очевидна наступна формула:

$$
d_{k+1}[i][j] = \sum_{p = 1}^{n} d_k[i][p] \cdot g[p][j].
$$

Легко замітити, що записана вище формула - не що інше, як добуток двох матриць $d_k$ і $g$ в самому звичайному сенсі:

$$
d_{k+1} = d_k \cdot g.
$$

Таким чином, **розв'язок** цій задачі можна уявити наступним чином:

$$
d_k = \underbrace{ g \cdot \ldots \cdot g}_{k\ {\rm times}} = g^k.
$$

Залишилося замітити, що піднесення матриці в ступінь можна провести ефективно з допомогою алгоритму [**Бинарного піднесення в ступінь**](binary_pow).

Отже, отримане розв'язок має асимптотику $O(n^3 \log k)$ і полягає в бінарному возведении в $k$-ую ступінь матриці суміжності графа.

## Кратчайшие шляхи фіксованою довжини

Нехай завдань орієнтований зважений граф $G$ з $n$ вершинами, і задано ціле число $k$. Потрібно для кожної пари вершин $i$ і $j$ знайти довжину найкоротшого шляхи між цими вершинами, що складається рівне з $k$ ребер.

Будемо вважати, що граф завдань **матрицею суміжності**, тобто матрицею $g[][]$ розміру $n \times n$, де кожний елемент $g[i][j]$ містить довжину ребра з вершини $i$ в вершину $j$. Якщо між якимись вершинами ребра ні, то відповідний елемент матриці припустимо рівним нескінченності $\infty$.

Очевидно, що в такому вигляді **матриця суміжності** графа є **відповіддю на задачу при $k=1$** - вона містить довжини найкоротших шляхів між кожної парою вершин, або $\infty$, якщо шляхи довжини $1$ не існує.

Розв'язок будемо будувати **ітеративно**: нехай відповідь для деякого $k$ знайдений, покажемо, як побудувати його для $k+1$. Позначимо через $d_k$ знайдену матрицю відповідей для $k$, а через $d_{k+1}$ - матрицю відповідей, яку необхідно побудувати. Значить очевидна наступна формула:

$$
d_{k+1}[i][j] = \min_{p = 1 \ldots n} ( d_k[i][p] + g[p][j] ).
$$

Внимательно посмотрев на цю формулу, легко провести аналогію з матричным множенням: фактично, матриця $d_k$ множиться на матрицю $g$, тільки в операції множення замість суми по всім $p$ береться мінімум по всім $p$:

$$
d_{k+1} = d_k \odot g,
$$

де операція $\odot$ множення двох матриць визначається наступним чином:

$$
A \odot B = C \ \ \Longleftrightarrow\ \  C_{ij} = \min_{p=1 \ldots n} (A_{ip} + B_{pj}).
$$

Таким чином, **розв'язок** цій задачі можна уявити з допомогою цій операції множення наступним чином:

$$
d_k = \underbrace{ g \odot \ldots \odot g}_{k\ {\rm times}} = g^{\odot k}.
$$

Залишилося замітити, що піднесення в ступінь з цій операцією множення можна провести ефективно з допомогою алгоритму [**Бинарного піднесення в ступінь**](binary_pow), оскільки єдине необхідну для нього властивість - асоціативність операції множення - очевидно, є.

Отже, отримане розв'язок має асимптотику $O(n^3 \log k)$ і полягає в бінарному возведении в $k$-ую ступінь матриці суміжності графа з изменённой операцією множення матриць.

## Узагальнення на випадок, коли требуются шляхи довжини, не більш ніж задана довжина

Описанные вище розв'язку решают задачі, коли потрібно розглядати шляхи певної, фіксованою довжини. Однак ці ж розв'язку можна приспособить і для розв'язку задач, коли потрібно розглядати шляхи, містять **не більш** ніж заданий число ребер.

Сделать це можна, трохи модифицировав вхідний граф. Наприклад, якщо нас цікавлять тільки шляхи, заканчивающиеся в певної вершині $t$, то в граф можна **додати петлю** $(t,t)$ нульового ваги.

Якщо ж нас як і раніше цікавлять відповіді для всіх пар вершин, то просте додавання петель до всім вершин испортит відповідь. Замість цього можна **раздвоить** кожну вершину: для кожної вершини $v$ створити додаткову вершину $v'$, провести ребро $(v,v')$ і додати петлю $(v',v')$.

Решив на модифікованому графі задачу про пошуку шляхів фіксованою довжини, відповіді на исходную задачу будуть виходити як відповіді між вершинами $i$ і $j'$ (тобто додаткові вершини - це вершини-закінчення, в яких ми можемо "покрутиться" потрібне число раз).
