# Теорія Шпрага-Гранді. Ним

## Введение

Теорія Шпрага-Гранді - це теория, описывающая так называемые **равноправные** (англ. "impartial") гри двох гравців, тобто гри, в яких разрешённые ходи і виграшність/програшність залежать тільки від стан гри. Від того, який саме з двох гравців ходит, не залежить нічого: тобто гравці повністю равноправны.

Крім того, передбачається, що гравці располагают всій информацией (про правилах гри, можливих ходах, положенні соперника).

Передбачається, що гра **конечна**, тобто при будь-який стратегії гравці рано або пізно придут в **проигрышную** позицію, з якій ні переходів в інші позиції. Ця позиція є проигрышной для гравця, який повинен робити хід з цій позиції. Відповідно, вона є виграшній для гравця, пришедшего в цю позицію. Зрозуміло, ничейных исходов в такий грі не буває.

Іншими словами, таку гру можна повністю описати **орієнтованим ациклическим графом**: вершинами в ньому є стан гри, а ребрами - переходи з одного стан гри в інше в результаті ходу поточного гравця (повторимося, в цим першо] і другий гравець равноправны). Одна або декілька вершин не мають вихідних ребер, вони є проигрышными вершинами (для гравця, який повинен здійснювати хід з такий вершини).

Оскільки ничейных исходов не буває, то всі стан гри розпадаються на два класу: **виграшні і програшні**. Выигрышные - це такі стан, що знайдеться хід поточного гравця, який приведе до неминуемому ураження іншого гравця навіть при його оптимальної грі. Відповідно, програшні стан - це стан, з яких всі переходи ведуть в стан, приводящие до победе іншого гравця, незважаючи на "сопротивление" першого гравця. Іншими словами, выигрышным буде стан, з якого є хоча б один перехід в програшне стан, а проигрышным є стан, з якого всі переходи ведуть в виграшні стан (або з якого взагалі ні переходів).

Наша задача - для будь-який заданої гри провести классификацию станів цій гри, тобто для кожного стан визначити, выигрышное воно або програшне.

Теорию таких ігор незалежно разработали Роланд Шпраг (Roland Sprague) в 1935 р. і Патрик Майкл Гранді (Patrick Michael Grundy) в 1939 р.

## Гра "Ним"

Ця гра є одним з прикладів описываемых вище ігор. Більш того, як ми побачимо трохи пізніше, **будь-яка** з равноправных ігор двох гравців насправді эквивалентна грі "ним" (англ. "nim"), тому вивчення цій гри автоматично дозволить нам розв'язувати всі інші гри (втім, про цим пізніше).

Исторически, ця гра була популярна ще в древние часи. Вероятно, гра бере своє происхождение в Китае - по крайньої міру, китайская гра "Jianshizi" дуже схожа на ним. В Европе перші упоминания про аніме відносяться до XVI в. Саме назва "ним" придумал математик Чарлз Бутон (Charles Bouton), який в 1901 р. опублікував повний аналіз цій гри. Происхождение названия "ним" доподлинно неизвестно.

### Опис гри

Гра "ним" представляє з собі наступну гру.

Є декілька купок, в кожної з яких по нескольку каменів. За один хід гравець можливо взяти з який-нибудь однієї купки будь-яке ненульове число каменів і выбросить їх. Відповідно, проигрыш настає, коли ходів більше не залишилося, тобто всі купки пусты.

Отже, стан гри "ним" однозначно описується неупорядоченным набором натуральных чисел. За один хід дозволяється строго зменшити будь-яке з чисел (якщо в результаті число стане нулем, то воно видаляється з набору).

### Розв'язок німа

Розв'язок цій гри опублікував в 1901 р. Чарлз Бутон (Charles L. Bouton), і виглядає воно наступним чином.

**Теорема**. Текущий гравець має виграшну стратегию тоді і тільки тоді, коли XOR-сума розмірів купок відмінна від нуля. В іншому випадку поточний гравець знаходиться в проигрышном стані. (XOR-сумою чисел $a_i$ називається вираз $a_1 \oplus a_2 \oplus \ldots \oplus a_n$, де $\oplus$ - операція побітового исключающего або)

**Доведення**.

Основна суть приведённого нижче доведення - в наявності **симметричной стратегії для суперника**. Ми покажемо, що, оказавшись в стані з нульовий XOR-сумою, гравець не зможе вийти з цього стан - при будь-якому його переході в стан з ненульовий XOR-сумою у суперника знайдеться ответный хід, возвращающий XOR-суму назад в нуль.

Приступим тепер до формальному доказательству (воно буде конструктивним, тобто ми покажемо, як саме виглядає симетрична стратегія суперника - який саме хід потрібно буде йому здійснювати).

Доводити теорему будемо по індукції.

Для порожнього німа (коли розміри всіх купок рівні нулю) XOR-сума рівна нулю, і теорема вірна.

Нехай тепер ми хочемо довести теорему для деякого стан гри, з якого є хоча б один перехід. Користуючись предположением індукції (і ацикличностью гри) ми припустимо, що теорема доведена для всіх станів, в які ми можемо потрапити з поточного.

Значить доведення розпадається на дві частини: якщо XOR-сума $s$ в поточному стані $=0$, то треба довести, що поточний стан програшно, тобто всі переходи з нього ведуть в стан з XOR-сумою $t \ne 0$. Якщо ж $s \ne 0$, то треба довести, що знайдеться перехід, приводящий нас в стан з $t = 0$.

* Нехай $s = 0$, тоді ми хочемо довести, що поточний стан - програшно. Розглянемо будь-який перехід з поточного стан німа: позначимо через $p$ номер изменяемой купки, через $x_i$ ($i = 1 \ldots n$) - розміри купок до ходу, через $y_i$ ($i = 1 \ldots n$) - після ходу. Значить, користуючись элементарными свойствами функції $\oplus$, ми маємо:

$$
t = s \oplus x_p \oplus y_p = 0 \oplus x_p \oplus y_p = x_p \oplus y_p.
$$

Але оскільки $y_p < x_p$, то це означає, що $t \ne 0$. Значить, нове стан буде мати ненулевую XOR-суму, тобто, згідно базі індукції, буде выигрышным, що і потрібно довести.

* Нехай $s \ne 0$. Значить наша задача - довести, що поточний стан - виграшно, тобто з нього існує хід в програшне стан (з нульовий XOR-сумою).

Розглянемо битовую запис числа $s$. Візьмемо старший ненульовий біт, нехай його номер рівний $d$. Нехай $k$ - номер тією купки, у розмір $x_k$ якій $d$-ый біт відмінний від нуля (таке $k$ знайдеться, інакше б в XOR-сумі $s$ цей біт не вийшов б отличным від нуля).

Значить, затверджується, шуканий хід - це змінити $k$-ую купку, зробивши її розміру $y_k = x_k \oplus s$.

Убедимся в цим.

Спочатку треба перевірити, що це хід корректный, тобто що $y_k < x_k$. Однак це вірно, оскільки всі біти, старшие $d$-го, у $x_k$ і $y_k$ збігаються, а в $d$-ом біті у $y_k$ буде нуль, а у $x_k$ буде одиниця.

Тепер порахуємо, яка XOR-сума вийде при цим під час:

$$
t = s \oplus x_k \oplus y_k = s \oplus x_k \oplus (s \oplus x_k) = 0.
$$

Таким чином, зазначений нами хід - дійсно хід в програшне стан, а це і доводить, що поточний стан виграшно.

Теорема доведена.

**Слідство**. Будь-яке стан ним-гри можна замінити еквівалентним станом, що складається з єдиною купки розміру, рівного XOR-сумі розмірів купок в старом стані.

Іншими словами, при анализе німа з несколькими купками можна порахувати XOR-суму $s$ їх розмірів, і перейти до анализу німа з єдиною купки розміру $s$ - як показує тільки що доказанная теорема, виграшність/програшність від цього не зміниться.

## Эквивалентность будь-який гри німу. Теорема Шпрага-Гранді

Тут ми покажемо, як будь-який грі (рівноправній грі двох гравців) поставити в відповідність ним. Іншими словами, будь-якого станом будь-який гри ми навчимося ставити в відповідність ним-купку, повністю описывающее стан вихідної гри.

### Лема про аніме з збільшеннями

Доведемо спочатку дуже важную лему - **лему про аніме з збільшеннями**.

А саме, розглянемо наступного модифікований ним: усе так ж, як і в звичайному аніме, однак тепер дозволяється додатковий вид ходу: замість зменшення, навпаки, **збільшити розмір деякої купки**. Якщо бути більш точним, то хід гравця тепер полягає в тому, що він або забирает ненульове кількість каменів з який-нибудь купки, або збільшує розмір який-або купки (в відповідно з некими правилами, див. наступного абзац).

Тут важливо розуміти, що правила того, як саме гравець можливо здійснювати збільшення, **нас не цікавлять** - однак такі правила усе ж повинні бути, аби наша гра як і раніше була **ациклічності**. Нижче в розділі "Приклади ігор" розглянуті примеры таких ігор: "сходовий ним", "nimble-2", "turning turtles".

Повторимся, лема буде доведена нами взагалі для будь-яких ігор такого увазі - ігор увазі "ним з збільшеннями"; конкретные правила збільшень в доведенні ніяк не використовуються.

**Формулювання леми**. Ним з збільшеннями еквівалентний обычному німу, в тому сенсі, що виграшність/програшність стан визначається по теоремі Бутона згідно XOR-сумі розмірів купок. (Або, іншими словами, суть леми в тому, що збільшення бесполезны, їх ні сенсу застосовувати в оптимальної стратегії, і вони ніяк не змінюють виграшність/програшність по порівняно з звичайним німом).

**Доведення**.

Ідея доведення, як і в теоремі Бутона - в наявності **симметричной стратегії**. Ми покажемо, що збільшення нічого не змінюють, оскільки після того, як один з гравців прибегнет до збільшення, іншої зможе симетрично відповісти йому.

Насправді, припустимо, що поточний гравець здійснює хід-збільшення який-або купки. Значить його соперник зможе просто відповісти йому, уменьшив назад цю купку до старого значення - адже звичайні ходи німа у нас як і раніше можуть свободно використовуватися.

Таким чином, симметричным відповіддю на хід-збільшення буде хід-зменшення назад до старого розміру купки. Отже, після такого відповіді гра вернётся назад до тим ж размерам купок, тобто гравець, совершивший збільшення, нічого від цього не виграє. Т.до. гра ациклічності, то рано або пізно ходи-збільшення кончатся, і поточному гравцеві доведеться робити хід-зменшення, а це і означає, що наявність збільшують ходів не змінює ровным счётом нічого.

### Теорема Шпрага-Гранді про еквівалентності будь-який гри німу

Перейдемо тепер до самому главному в даній статті факту - теоремі про еквівалентності німу будь-який рівноправній гри двох гравців.

**Теорема Шпрага-Гранді**. Розглянемо будь-яке стан $v$ деякої рівноправній гри двох гравців. Нехай з нього є переходи в деякі стан $v_i$ $(i=1 \ldots k)$ (де $k \ge 0$). Стверджується, що станом $v$ цій гри можна поставити в відповідність купку німа деякого розміру $x$ (яка буде повністю описувати стан $v$ нашій гри - тобто ці два стан двох різних ігор будуть еквівалентні). Це число $x$ - називається **значенням Шпрага-Гранді** стан $v$.

Більш того, це число $x$ можна знаходити наступним рекурсивным чином: порахуємо значення Шпрага-Гранді $x_i$ по кожному переходу $(v,v_i)$, і тоді виконується:

$$
x = {\rm mex} \{ x_1, \ldots, x_k \},
$$

де функція $\rm mex$ від множини чисел повертає найменше невід'ємне число, не встречающееся в цим множині (назва "mex" - це сокращение від "minimum excludant").

Таким чином, ми можемо, стартуя від вершин без вихідних ребер, поступово **порахувати значення Шпрага-Гранді для всіх станів нашій гри**. Якщо значення Шпрага-Гранді какого-або стан рівне нулю, то це стан програшно, інакше - виграшно.

**Доведення**. Доводити теорему будемо по індукції.

Для вершин, з яких ні ні одного переходу, величина $x$ згідно теоремі буде виходити як $\rm mex$ від порожнього множини, тобто $x = 0$. Але, насправді, стан без переходів - це програшне стан, і йому дійсно повинна відповідати ним-купка розміру $0$.

Розглянемо тепер будь-яке стан $v$, з якого є переходи. За індукції ми можемо вважати, що для всіх станів $v_i$, в які ми можемо перейти з поточного стан, значення $x_i$ вже підраховані.

Порахуємо величину $p = {\rm mex} \{ x_1, \ldots, x_k \}$. Значить, згідно визначенню функції $\rm mex$, ми отримуємо, що для будь-якого числа $i$ в проміжку $[0; p)$ знайдеться хоча б один відповідний перехід в якесь з $v_i$-их стан. Крім того, можуть існувати також додаткові переходи - в стан зі значеннями Гранді, великими $p$.

Це означає, що поточний стан **еквівалентно станом німу з збільшеннями з кучкой розміру $p$**: насправді, у нас є переходи з поточного стан в стан з купками всіх менших розмірів, а також можуть бути переходи в стан великих розмірів.

Отже, величина ${\rm mex} \{ x_1, \ldots, x_k \}$ дійсно є шуканим значенням Шпрага-Гранді для поточного стан, що і потрібно довести.

## Застосування теореми Шпрага-Гранді

Опишемо нарешті целостный алгоритм, применимый до будь-який рівноправній грі двох гравців для визначення выигрышности/проигрышности поточного стан $v$.

Функція, яка кожному станом гри ставит в відповідність ним-число, називається **функцією Шпрага-Гранді**.

Отже, аби порахувати функцію Шпрага-Гранді для поточного стан деякої гри, потрібно:

* Выписать всі можливі переходи з поточного стан.

* Кожен такий перехід можливо вести або в одну гру, або в **суму незалежних ігор**.

В першому випадку - просто порахуємо функцію Гранді рекурсивно для цього нового стан.

У іншому випадку, коли перехід з поточного стан призводить в суму декількох незалежних ігор - рекурсивно порахуємо для кожної з цих ігор функцію Гранді, а потім скажімо, що функція Гранді суми ігор рівна XOR-сумі значень цих ігор.

* Після того, як ми порахували функцію Гранді для кожного можливого переходу - припустимо $\rm mex$ від цих значень, і знайдене число - і є шукане значення Гранді для поточного стан.

* Якщо отримане значення Гранді рівне нулю, то поточний стан програшно, інакше - виграшно.

Таким чином, по порівняно з теоремою Шпрага-Гранді тут ми враховуємо то, що в грі можуть бути переходи з окремих станів в **суми декількох ігор**. Щоб працювати з суммами ігор, ми спочатку замінюємо кожну гру її значенням Гранді, тобто однієї ним-кучкой деякого розміру. Після цього ми приходимо до сумі декількох ним-купок, тобто до обычному німу, відповідь для якого, згідно теоремі Бутона - XOR-сума розмірів купок.

## Закономерности в значениях Шпрага-Гранді

Очень часто при рішенні конкретних задач, коли потрібно навчитися вважати функцію Шпрага-Гранді для заданої гри, помогает **вивчення таблиц значень** цій функції в поисках закономерностей.

У багатьох играх, кажущихся вельми трудными для теоретического анализа, функція Шпрага-Гранді на практиці виявляється періодичної, або ж имеющей дуже простий вид, який легко замітити "на глаз". В подавляющем більшості випадків увиденные закономірності є верными, і при бажанні доказываемыми з допомогою математичної індукції.

Втім, далеко не завжди функція Шпрага-Гранді містить прості закономірності, а для деяких, навіть вельми простих по формулюванні, ігор питання про наявності таких закономерностей до сих пір відкритий (наприклад, "Grundy's game" нижче).

## Приклади ігор

Для наглядной демонстрации теорії Шпрага-Гранді, разберём декілька задач.

Особливо випливає звернути увага на задачі "сходовий ним", "nimble-2", "turning turtles", в якій демонструється нетривиальное зведення вихідної задачі до німу з збільшеннями.

### "Хрестики-хрестики"

**Умова**. Розглянемо клетчатую смужку розміру $1 \times n$ клітин. За один хід гравцеві треба поставити один хрестик, але при цим заборонено ставити два хрестика поруч (в сусідні клітини). Програє той, хто не можливо зробити хід. Сказать, хто виграє при оптимальної грі.

**Розв'язок**. Коли гравець ставит хрестик в яку-або клітинку, можна вважати, що вся смужка розпадається на дві незалежні половинки: ліворуч від хрестика і справа від нього. При цим сама клітина з крестиком, а також її лівий і правий сосед уничтожаются - т.до. в них більше нічого не можна буде поставити.

Отже, якщо ми занумеруем клітини смужки від $1$ до $n$, то, поставивши хрестик в позицію $1 < i < n$, смужка распадётся на дві смужки довжини $i-2$ і $n-i-1$, тобто ми переходимо в суму двох ігор $i-2$ і $n-i-1$. Якщо ж хрестик ставиться в позицію $1$ або $n$, то це особливий випадок - ми просто перейдемо в стан $n-2$.

Таким чином, функція Гранді $g[n]$ має вид (для $n \ge 3$):

$$
g[n] = {\rm mex} \Bigg\{ g[n-2], \bigcup_{i=2}^{n-1} \Big( g[i-2] \oplus g[n-i-1] \Big) \Bigg\}.
$$

тобто. $g[n]$ виходить як $\rm mex$ від множини, що складається з числа $g[n-2]$, а також всіляких значень вираження $g[i-2] \oplus g[n-i-1]$.

Отже, ми отримали розв'язок цій задачі за $O(n^2)$.

Насправді, вважаючи на комп'ютері таблицю значень для першо] сотни значень $n$, можна побачити, що, починаючи з $n=52$, послідовність $g[n]$ стає періодичної з періодом $34$. Ця закономірність зберігається і далі (що, ймовірно, можна довести по індукції).

### "Хрестики-хрестики - 2"

**Умова**. Знову гра ведеться на смужці $1 \times n$ клітин, і гравці по черги ставят по одному крестику. Выигрывает той, хто поставит три хрестика поспіль.

**Розв'язок**. Зауважимо, що якщо $n>2$ і ми оставили після свого ходу два хрестика поруч або через один пробел, то противник наступним ходом виграє. Отже, якщо один гравець поставил де-то хрестик, то іншому гравцеві не вигідно ставити хрестик в сусідні з ним клітини, а також в сусідні з сусідніми (тобто на відстані $1$ і $2$ ставити не вигідно, це приведе до ураження).

Значить розв'язок виходить практично аналогічним попередньою задачі, тільки тепер хрестик удаляет у кожної половинки не по однієї, а зразу по дві клітини.

### "Пешки"

**Умова**. Є поле $3 \times n$, на якому в першому і третьому ряду стоять по $n$ пешек - белых і чорних, відповідно. Перший гравець ходит белыми пешками, другий - чёрными. Правила ходу і удара - стандартні шахматные, за винятком того, що бить (при наявності такий возможности) обов'язково.

**Розв'язок**. Проследим, що відбувається, коли одна пешка зробить хід вперед. Следующим ходом противник буде обязан съесть її, потім ми будемо зобов'язані съесть пішака суперника, потім знову він съест, і, нарешті, наша пешка съест вражескую пішака і залишиться, "упёршись" в пішака суперника. Таким чином, якщо ми в самому початку пошли пешкой в колонке $1 < i < n$, то в результаті три колонки $[i-1; i+1]$ дошки фактично уничтожатся, і ми перейдемо до сумі ігор розміру $i-2$ і $n - i - 1$. Граничные випадки $i=1$ і $i=n$ призводять нас просто до дошці розміру $n-2$.

Таким чином, ми отримали вираження для функції Гранді, аналогічні рассмотренной вище задачі "Хрестики-хрестики".

### "Lasker's nim"

**Умова**. Є $n$ купок каменів заданих розмірів. За один хід гравець можливо взяти будь-яке ненульове число каменів з який-або купки, або ж розділити яку-або купку на дві непусті купки. Програє той, хто не можливо зробити хід.

**Розв'язок**. Записывая обидва увазі переходів, легко получити функцію Шпрага-Гранді як:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-1} g[i], ~~ \bigcup_{i=1}^{n-1} \Big( g[i] \oplus g[n-i] \Big) \Bigg\}.
$$

Однак можна побудувати таблицю значень для малых $n$ і побачити просту закономірність:

$$
\matrix{
n & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 & 13 & 14 & 15 & 16 & 17 & 18 & 19 \cr
g[n] & 0 & 1 & 2 & 4 & 3 & 5 & 6 & 8 & 7 & 9 & 10 & 12 & 11 & 13 & 14 & 16 & 15 & 17 & 18 & 20 \cr
}
$$

Тут видно, що $g[n] = n$ для чисел, рівних $1$ або $2$ за модулем $4$, і $g[n] = n \pm 1$ для чисел, рівних $3$ і $0$ за модулем $4$. Довести це можна по індукції.

### "The game of Kayles"

**Умова**. Є $n$ кегель, выставленных в ряд. За один удар гравець можливо выбить або одну кеглю, або дві поруч стоять кегли. Выигрывает той, який выбил останню кеглю.

**Розв'язок**. І коли гравець выбивает одну кеглю, і коли він выбивает дві - гра розпадається на суму двох незалежних ігор.

Неважко получити таке вираз для функції Шпрага-Гранді:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-1} \Big( g[i] \oplus g[n-1-i] \Big), ~~ \bigcup_{i=0}^{n-2} \Big( g[i] \oplus g[n-2-i] \Big) \Bigg\}.
$$

Порахуємо для нього таблицю для декількох перших десятків елементів:

$$
\matrix{
g[0 \ldots 11]: & 0 & 1 & 2 & 3 & 1 & 4 & 3 & 2 & 1 & 4 & 2 & 6 \cr
g[12 \ldots 23]: & 4 & 1 & 2 & 7 & 1 & 4 & 3 & 2 & 1 & 4 & 6 & 7 \cr
g[24 \ldots 35]: & 4 & 1 & 2 & 8 & 5 & 4 & 7 & 2 & 1 & 8 & 6 & 7 \cr
g[36 \ldots 47]: & 4 & 1 & 2 & 3 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[48 \ldots 59]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 4 & 2 & 7 \cr
g[60 \ldots 71]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 6 & 7 \cr
g[72 \ldots 83]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[84 \ldots 95]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[96 \ldots 107]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
g[108 \ldots 119]: & 4 & 1 & 2 & 8 & 1 & 4 & 7 & 2 & 1 & 8 & 2 & 7 \cr
}
$$

Можна замітити, що, починаючи з деякого моменту, послідовність стає періодичної з періодом $12$. В надалі ця периодичность також не нарушится.

### Grundy's game

**Умова**. Є $n$ купок каменів, розміри яких ми позначимо через $a_i$. За один хід гравець можливо взяти яку-або купку розміру як мінімум $3$ і розділити її на дві непусті купки неравных розмірів. Програє той, хто не можливо зробити хід (тобто коли розміри всіх залишилися купок менше або рівні двом).

**Розв'язок**. Якщо $n > 1$, то всі ці декілька купок, очевидно, - незалежні гри. Отже, наша задача - навчитися шукати функцію Шпрага-Гранді для однієї купки, а відповідь для декількох купок буде виходити як їх XOR-сума.

Для однієї купки ця функція будується також легко, достатньо переглянути всі можливі переходи:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=[1 \ldots n-1], \atop i \ne n-i } \Big( g[i] \oplus g[n-i] \Big) \Bigg\}.
$$

Чем ця гра интересна - тим, що до сих пір для її не знайдено загальної закономірності. Незважаючи на предположения, що послідовність $g[n]$ повинна бути періодичної, вона була просчитана аж до $2^{35}$, і периодов в цій області обнаружено не було.

### "Лестничный ним"

**Умова**. Є лестница з $n$ ступеньками (занумерованными від $1$ до $n$), на $i$-ой ступеньке лежить $a_i$ монет. За один хід дозволяється переместить деякий ненульове число монет з $i$-ой на $i-1$-ую ступеньку. Програє той, хто не можливо зробити ходу.

**Розв'язок**. Якщо спробувати звести цю задачу до німу "в лоб", то вийде, що хід у нас - це зменшення однієї купки на скільки-то, і одновременное збільшення іншої купки на стільки ж. В результаті ми отримуємо модифікацію німа, розв'язати яку вельми складно.

Поступим по-іншому: розглянемо тільки ступеньки з парними номерами: $a_2, a_4, a_6, \ldots$. Подивимося, як буде змінюватися цей набір чисел при совершении одного ходу.

Якщо хід робиться з чётным $i$, то тоді цей хід означає зменшення числа $a_i$. Якщо ж хід робиться з непарним $i$ ($i > 1$), то це означає збільшення $a_{i-1}$.

Получается, що наша задача - це обыкновенный ним з збільшеннями з размерами купок $a_2, a_4, a_6, \ldots$.

Отже, функція Гранді від нього - це XOR-сума чисел увазі $a_{2i}$.

### "Nimble" і "Nimble-2"

**Умова**. Є клетчатая смужка $1 \times n$, на якій розташовані $k$ монет: $i$-ая монета знаходиться в $a_i$-ой клітці. За один хід гравець можливо взяти якусь монету і подвинуть її вліво на довільне число клітин, але так, аби вона не вылезла за межі смужки. В грі "Nimble-2" додатково запрещается перепрыгивать інші монети (або навіть ставити дві монети в одну клітинку). Програє той, хто не можливо зробити хід.

**Розв'язок "Nimble"**. Зауважимо, що монети в цій грі независимы один від одного. Більш того, якщо ми розглянемо набір чисел $a_i-1$ $(i = 1 \ldots k)$, то зрозуміло, що за один хід гравець можливо взяти будь-яке з цих чисел і зменшити його, а проигрыш настає, коли всі числа обращаются в нуль. Отже, гра "Nimble" - це **звичайний ним**, і відповіддю на задачу є XOR-сума чисел $a_i-1$.

**Розв'язок "Nimble-2"**. Перенумеруем монети в порядку їх слідування ліворуч направо. Значить позначимо через $d_i$ відстань від $i$-ой до $i-1$-ой монети:

$$
d_i = a_i - a_{i-1} - 1, (i = 1 \ldots k)
$$

(вважаючи, що $a_0 = 0$).

Значить за один гравець можливо відняти від какого-нибудь $d_p$ деякий число $q$, і додати це ж число $q$ до $d_{p+1}$. Таким чином, ця гра - це фактично **"сходовий ним"** над числами $d_i$ (треба лише змінити порядок цих чисел на протилежний).

### "Turning turtles" і "Twins"

**Умова**. Дана клетчатая смужка розміру $1 \times n$. В кожної клітці варто або хрестик, або нулик. За один хід можна взяти якийсь нулик і перетворити його в хрестик.

При цим **додатково** дозволяється вибрати одну з клітин ліворуч від изменяемой і змінити в ній значення на протилежне (тобто нулик замінити на хрестик, а хрестик - на нулик). В грі "turning turtles" робити це не обов'язково (тобто хід гравця можливо ограничиваться превращением нолика в хрестик), а в "twins" - обов'язково.

**Розв'язок "turning turtles"**. Стверджується, що ця гра - це звичайний ним над числами $b_i$, де $b_i$ - позиція $i$-го нолика (в 1-індексації). Перевіримо це твердження.

\ul {

* Якщо гравець просто поміняв нулик на хрестик, не воспользовавшись додатковим ходом - то це можна розуміти як то, що він просто забрал всю купку, відповідну цьому нолику. Іншими словами, якщо гравець поміняв нулик на хрестик в позиції $x$ $(1 \le x \le n)$, то тим самим він взял купку розміру $x$ і сделал її розмір рівним нулю.

* Якщо гравець воспользовался додатковим ходом, тобто крім того, що поміняв нулик в позиції $x$ на хрестик, він ще изменил клітинку в позиції $y$ $(y < x)$, то можна вважати, що він уменьшил купку $x$ до розміру $y$. Дійсно, якщо в позиції $y$ раніше був хрестик - то, насправді, після ходу гравця там стане нулик, тобто з'явиться купка розміру $y$. А якщо в позиції $y$ раніше був нулик, то після ходу гравця ця купка исчезает - або, що то ж саме, появилась друга купка точно такого ж розміру $y$ (оскільки в аніме дві купки однакових розмірів фактично "знищують" один одного).

}

Таким чином, відповідь на задачу - це XOR-сума чисел - координат всі ноликов в 1-індексації.

**Розв'язок "twins"**. Усе міркування, наведені вище, остаются вірні, за винятком того, що ходу "обнулить купку" тепер у гравця ні. тобто. якщо ми від всіх координат отнимем одиницю - то знову гра перетвориться в звичайний ним.

Таким чином, відповідь на задачу - це XOR-сума чисел - координат всі ноликов в 0-індексації.

### Northcott's game

**Умова**. Є доска розміру $n \times m$: $n$ стрічок і $m$ стовпців. В кожної стрічки стоять по дві фішки: одна чёрная і одна белая. За один хід гравець можливо взяти будь-яку фішку свого кольори і подвинуть її всередині стрічки вправо або вліво на довільне число кроків, але не перепрыгивая через іншу фішку (і не вставая на її). Програє той, хто не можливо зробити ходу.

**Розв'язок**. По-перше, зрозуміло, що кожна з $n$ стрічок дошки утворює независимую гру. Тому задача зводиться до анализу гри в однієї стрічки, а відповіддю на задачу буде XOR-сума значень Шпрага-Гранді для кожної з стрічок.

Решая задачу для однієї стрічки, позначимо через $x$ відстань між чёрной і білою фишкой (яке можливо змінюватися від нуля до $m-2$). За один хід кожний гравець можливо або зменшити $x$ на деякий довільне значення, або, можливо, збільшити його до деякого значення (збільшення доступны не завжди). Таким чином, ця гра - це **"ним з збільшеннями"**, і, як ми вже знаємо, збільшення в цій грі бесполезны. Отже, функція Гранді для однієї стрічки - це і є це відстань $x$.

(Слід замітити, що формально таке рассуждение неполно - т.до. в "аніме з збільшеннями" передбачається, що гра **конечна**, а тут правила гри дозволяють игрокам играть нескінченно довго. Втім, бесконечная гра не можливо мати місця при оптимальної грі - т.до. варто одному гравцеві збільшити відстань $x$ (ціною наближення до кордоні поля), як іншої гравець приблизится до нього, уменьшив $x$ назад. Отже, при оптимальної грі суперника гравцеві не удастся здійснювати збільшують ходи нескінченно довго, тому усе ж описанное розв'язок задачі залишається в силе).

### Триомино

**Умова**. Дано клетчатое поле розміру $2 \times n$. За один хід гравець можливо поставити на поле одну фігурку в формі букви "Г" (тобто связную фігуру з трьох клітин, не лежачих на однієї прямої). Запрещено ставити фігурку так, аби вона пересеклась хоча б однієї клеткой з якийсь з вже поставлених фигурок. Програє той, хто не можливо зробити хід.

**Розв'язок**. Зауважимо, що постановка однієї фигурки розбиває усе поле на два незалежних поля. Таким чином, нам треба анализировать не тільки прямоугольные поля, але і поля, у яких ліва і/або права межі неровные.

Нарисовав різні конфигурации, можна зрозуміти, що який б ні була конфигурация поля, головне - лише то, скільки на цим поле клітин. Насправді, якщо в поточному поле $x$ свободных клітин, і ми хочемо розбити це поле на два поля розміром $y$ і $z$ (де $y+z+3 = x$), то це завжди можна зробити, тобто завжди можна знайти відповідне місце для фигурки.

Таким чином, наша задача перетворюється в таку: спершу у нас є купка каменів розміру $2n$, і за один хід ми можемо выкинуть з деякої купки $3$ камня і потім розбити цю купку на дві купки довільних розмірів. Функція Гранді для такий гри має вид:

$$
g[n] = {\rm mex} \Bigg\{ \bigcup_{i=0}^{n-3} \Big( g[i] \oplus g[n-i-3] \Big) \Bigg\}.
$$

### Фишки на графі

**Умова**. Дан орієнтований ациклічний граф. В деяких вершинах графа стоять фішки. За один хід гравець можливо взяти якусь фішку і передвинуть її уздовж какого-або ребра в нову вершину. Програє той, хто не можливо зробити хід.

Також буває і другий різновид цій задачі: коли вважається, що якщо дві фішки приходят в одну вершину, то вони обидві взаємно знищують один одного.

**Розв'язок першого варіанти задачі**. По-перше, всі фішки - независимы один від одного, тому наша задача - навчитися шукати функцію Гранді для однієї фішки в графі.

Враховуючи, що граф аціклічен, ми можемо робити це рекурсивно: припустимо, що ми порахували функцію Гранді для всіх нащадків поточній вершини. Значить функція Гранді в поточній вершині - це $\rm mex$ від цього множини чисел.

Таким чином, розв'язком задачі є випливає: для кожної вершини рекурсивно порахувати функцію Гранді, якщо б фишка стояла саме в цій вершині. Після цього відповіддю на задачу буде XOR-сума значень Гранді від тих вершин графа, в яких по умові стоять фішки.

**Розв'язок іншого варіанти задачі**. Насправді, другий різновид задачі нічим не відрізняється від першого. Насправді, якщо дві фішки стоять в однієї і тією ж вершині графа, то в результуючій XOR-сумі їх значення Гранді взаємно знищують один одного. Отже, фактично це одна і та ж задача.

## Реалізація

З позиції реалізації интерес можливо представляти реалізація функції $\rm mex$.

Якщо це не є узким местом в програмі, то можна написати який-нибудь простий різновид за $O(c \log c)$ (де $c$ - кількість аргументів):

<!--- TODO: specify code snippet id -->
``` cpp
int mex(vector<int> a) {
    set<int> b(a.begin(), a.end());
    for (int i=0; ; ++i)
        if (!b.count(i))
            return i;
}
```

Втім, не так уж і складним є різновид **за лінійне час**, тобто за $O(c)$, де $c$ - число аргументів функції $\rm mex$. Позначимо через $D$ константу, рівну максимально можливого значенням $c$ (тобто максимальної степені вершини в графі гри). В такому випадку результат функції $\rm mex$ не буде перевершувати $D$.

Отже, при реалізації достатньо завести масив розміру $D+1$ (масив глобальный, або статический - головне, аби він не создавался при кожному виклику функції). При виклику функції $\rm mex$ ми спочатку відзначимо в цим масиві всі $c$ аргументів (пропустив ті з них, які більше $D$ - такі значення, очевидно, не впливають на результат). Потім проходом по цьому масиву ми за $O(c)$ найдемо перший неотмеченный елемент. Нарешті, в наприкінці можна знову пройтися по всім переданным аргументам і обнулить назад масив для них. Тим самим, ми виконаємо всі дії за $O(c)$, що на практиці можливо виявитися істотно менше максимальної степені $D$.

<!--- TODO: specify code snippet id -->
``` cpp
int mex (const vector<int> & a) {
    static bool used[D+1] = { 0 };
    int c = (int) a.size();

    for (int i=0; i<c; ++i)
        if (a[i] <= D)
            used[a[i]] = true;

    int result;
    for (int i=0; ; ++i)
        if (!used[i]) {
            result = i;
             2 break;
        }

    for (int  1 i=0; i<c; ++i)
        if (a[i] <= D)
            used[a[i]] = false;

    return result;
}
```

Інший різновид - скористатися техникой **"числового used"**. тобто. зробити $\rm used$ масивом не булевских змінних, а чисел ("версий"), і завести глобальную змінну, позначає номер поточній версії. При в ході в функцію $\rm mex$ ми збільшуємо номер поточній версії, в першому циклі ми проставляем в масиві $\rm used$ не $\rm true$, а номер поточній версії. Нарешті, у іншому циклі ми просто порівнюємо ${\rm used}[i]$ з номером поточній версії - якщо вони не збіглися, то це означає, що поточний число не встречалось в масиві $a$. Третий цикл (який раніше занулял масив $\rm used$) в такому рішенні не потрібен.

## Узагальнення німа: ним Мура ($k$-ним)

Одне з цікавих обобщений звичайного німа було дано Муром (Moore) в 1910 р.

**Умова**. Є $n$ купок каменів розміру $a_i$. Також задано натуральне число $k$. За один хід гравець можливо зменшити розміри від однієї до $k$ купок (тобто тепер разрешаются одновременные ходи в декількох купках зразу). Програє той, хто не можливо зробити ходу.

Очевидно, при $k=1$ ним Мура перетворюється в звичайний ним.

**Розв'язок**. Розв'язок такий задачі дивовижно просто. Запишем розміри кожної купки в двоичной системі числення. Потім підсумуємо ці числа в $k+1$-ичной системі числення без переносов розрядів. Якщо вийшло число нуль, то поточна позиція програшна, інакше - виграшна (і з її є хід в позицію з нульовий величиною).

Іншими словами, для кожного біта ми дивимося, варто цей біт або ні в двоичном поданні кожного числа $a_i$. Потім ми підсумовуємо получившиеся нулі/одиниці, і суму беремо за модулем $k+1$. Якщо в підсумку ця сума для кожного біта вийшла нульовий, то поточна позиція - програшна, інакше - виграшна.

**Доведення**. Як і для німа, доведення полягає в описі стратегії гравців: з однієї сторони, ми показываем, що з гри з нульовим значенням ми можемо перейти тільки в гру з ненульовим значенням, а з іншої сторони - що з гри з ненульовим значенням є хід в гру з нульовим значенням.

По-перше, покажемо, що з гри з нульовим значенням можна перейти тільки в гру з ненульовим значенням. Це цілком зрозуміло: якщо сума за модулем $k+1$ була рівна нулю, то після зміни від одного до $k$ біт ми не могли получити знову нульову суму.

По-друге, покажемо, як з гри з ненульовий суми перейти в гру з нульовий сумою. Будемо перебирати біти, в яких сума вийшла ненульовий, в порядку від старшего до младшему.

Позначимо через $u$ кількість купок, які ми вже начали змінювати; спершу $u = 0$. Звернемо увага, що в цих $u$ купках ми вже можемо ставити будь-які біти по нашому желанию (оскільки у будь-який купки, яка попадала в число цих $u$ купок, вже уменьшился один з попередніх, більш старших, бітів).

Отже, нехай ми розглядаємо поточний біт, в якому сума за модулем $k+1$ вийшла ненульовий. Позначимо через $s$ цю суму, але в якій не учитываются ті $u$ купок, які ми вже начали змінювати. Позначимо через $q$ суму, яку можна получити, поставивши в ці $u$ купок поточний біт рівним одиниці:

$$
q = (s + u) \pmod{(k+1)}
$$

У нас є два варіанти:

* Якщо $q \le u$.

Значить ми можемо обійтися тільки лише вже выбранными $u$ купками: достатньо в $k+1-s = u-q$ з них поставити поточний біт рівним одиниці, а у всіх інших - рівним нулю.

* Якщо $q > u$.

В такому випадку ми, навпаки, поставимо в вже обраних $u$ купках поточний біт рівним нулю. Значить сума в поточному біті буде рівна $s > 0$, а, значить, серед невыбранных $n-u$ купок в поточному біті є як мінімум $s$ одиниць. Виберемо які-нибудь $s$ купок серед них, і зменшимо в них поточний біт з одиниці до нуля.

В результаті число $u$ изменяемых купок збільшиться на $s$, і складе $q \le k$.

Таким чином, ми показали, яким чином вибирати множину изменяемых купок і які біти випливає в них змінювати, аби загальне їх кількість $u$ ніколи не превысило $k$.

Отже, ми довели, що шуканий перехід з стан з ненульовий сумою в стан з нульовий сумою існує, що і потрібно довести.

## "Ним в піддавання"

Тот ним, який ми розглядали у всій даній статті - називається також "нормальним німом" ("normal nim"). В протилежність йому, існує також **"ним в піддавання"** ("misère nim") - коли гравець, совершивший останній хід, проигрывает (а не выигрывает).

(до речі кажучи, по всій видимості, ним як настольная гра - більш популярен саме в версії "в піддавання", а не в "нормальної" версії)

**Розв'язок** такого німа дивовижно просто: будемо діяти так ж, як і в звичайному аніме (тобто порахуємо XOR-суму всіх розмірів купок, і якщо вона рівна нулю, то ми проиграем при будь-який стратегії, а інакше - выиграем, знайшовши перехід в позицію з нульовим значенням Шпрага-Гранді). Але є одне **виняток**: якщо розміри всіх купок рівні одиниці, то виграшність/програшність змінюються місцями по порівняно з звичайним німом.

Таким чином, виграшність/програшність німа "в піддавання" визначаються по числу:

$$
a_1 \oplus a_2 \oplus \ldots \oplus a_n \oplus z,
$$

де через $z$ позначена булевская змінна, рівна одиниці, якщо $a_1 = a_2 = \ldots = a_n = 1$.

З урахуванням цього исключения, **оптимальна стратегія** для гравця в виграшній позиції визначається наступним чином. Знайдемо хід, який гравець б совершил, якщо б він играл в нормальный ним. Тепер, якщо цей хід веде в позицію, в якій розміри всіх купок рівні одиниці (і при цим до цього ходу була купка розміру, більшого одиниці), то цей хід треба змінити: змінити так, аби кількість остающихся непустих купок изменило свою парність.

**Доведення**. Звернемо увага, що взагалі теория Шпрага-Гранді відноситься до "нормальним" играм, а не до играм в піддавання. Однак ним - одна з тих ігор, для яких розв'язок гри "в піддавання" не сильно відрізняється від розв'язку "нормальної" гри. (До Речі кажучи, розв'язок німа "в піддавання" було дано тим ж Чарлзом Бутоном, який описал розв'язок "нормального" німа).

Каким ж чином можна объяснить настільки странную закономірність - що виграшність/програшність німа "в піддавання" збігається з выигрышностью/проигрышностью "нормального" німа майже завжди?

Розглянемо деякий **течение гри**: тобто виберемо довільну стартову позицію і випишемо ходи гравців аж до завершення гри. Неважко зрозуміти, що при умови оптимальної гри соперников - гра завершиться тим, що залишиться одна купка розміру $1$, і гравець буде вынужден піти в ній і проиграть.

Отже, в будь-який грі двох оптимальных гравців рано або пізно настає **момент**, коли розміри всіх непустих купок рівні одиниці. Позначимо через $k$ число непустих купок в цей момент - тоді для поточного гравця ця позиція выигрышна тоді і тільки тоді, коли $k$ парне. тобто. ми убедились в тому, що в цих випадках виграшність/програшність німа "в піддавання" **противоположна** "нормальному" німу.

Знову повернемося до тому моменту, коли вперше в грі всі купки стали розміру $1$, і откатимся на один хід назад - прямо перед тим, як ця ситуація вийшла. Ми виявилися в ситуації, що одна купка має розмір $>1$, а всі інші купки (можливо, їх було нуль штук) - розміру $1$. Ця позиція очевидно выигрышна (т.до. ми насправді завжди можемо зробити такий хід, аби залишилося непарне число купок розміру $1$, тобто наведемо соперника до ураження). З іншої сторони, XOR-сума розмірів купок в цей момент відмінна від нуля - значить, тут "нормальный" ним **збігається** з німом "в піддавання".

Далі, якщо продовжимо откатываться по грі назад, то ми будемо приходить в стан, коли в грі було дві купки розміру $>1$, три купки, і т.д. Для всіх таких станів виграшність/програшність також буде збігатися з "нормальним" німом - просто тому, що коли у нас є більш однієї купки розміру $>1$, то всі переходи ведуть в стан з однієї і більш кучкой розміру $>1$ - а для всіх них, як ми вже показали, нічого по порівняно з "нормальним" німом **не змінилося**.

Таким чином, зміни в аніме "в піддавання" затрагивают тільки стан, коли всі купки мають розмір, рівний одиниці - що і потрібно довести.

## Задачі в online judges

Список задач в online judges, які можна розв'язувати з допомогою функції Гранді:

* [TIMUS #1465 **"Гра в пешки"** [складність: низька]](http://acm.timus.ru/problem.aspx?space=1&num=1465)

* [UVA #11534 **"Say Goodbye to Tic-Tac-Toe"** [складність: середня]](http://uva.onlinejudge.org/index.php?option=onlinejudge&page=show_problem&problem=2529)

## Література

* \book{John Horton Conway}{On numbers and games}{1979}{conway.djvu}
* [Bernhard von Stengel. **Lecture Notes on Game Theory**](http://jourdan.ens.fr/~laffargue/teaching/Incertain/Problemes/lectnotes.pdf)
