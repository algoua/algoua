# Дерево Штерна-Броко. Ряд Фарея

## Дерево Штерна-Броко

Дерево Штерна-Броко - це изящная конструкція, позволяющая побудувати множину всіх невід'ємних дробів. Вона була незалежно відкрита немецким математиком Морицем Штерном (Moritz Stern) в 1858 р. і французским часовщиком Ахиллом Броко (Achille Brocot) в 1861 р. Втім, по деяким даними, ця конструкція була відкрита ще древнегреческим вченим Эратосфеном (Eratosthenes).

На **нульовий** ітерації у нас є дві дроби:

$$
\frac{0}{1}, \frac{1}{0}
$$

(друга величина, строго кажучи, дробом не є; її можна розуміти як несократимую дріб, позначає нескінченність)

Далі, на кожному **последующей** ітерації береться цей список дробів і між каждыми двома сусідніми дробями $\frac{a}{b}$ і $\frac{c}{d}$ вставляется їх **медіанти**, тобто дріб $\frac{a+c}{b+d}$.

Так, на першо] ітерації поточний множину буде таким:

$$
\frac{0}{1}, \frac{1}{1}, \frac{1}{0}
$$

На другий:

$$
\frac{0}{1}, \frac{1}{2}, \frac{1}{1}, \frac{2}{1}, \frac{1}{0}
$$

На третьої:

$$
\frac{0}{1}, \frac{1}{3}, \frac{1}{2}, \frac{2}{3}, \frac{1}{1}, \frac{3}{2}, \frac{2}{1}, \frac{3}{1}, \frac{1}{0}
$$

Продолжая цей процес до **нескінченності**, затверджується, можна получити множину **всіх** невід'ємних дробів. Більш того, всі одержувані дроби будуть **різними** (тобто в поточному множині кожна дріб зустрічається не більш одного рази), **несократимыми** (числители і знаменники будуть виходити взаємно простими). Нарешті, всі дроби будуть автоматично **упорядоченными** по возрастанию. Доведення всіх цих замечательных властивостей дерева Штерна-Броко буде наведено трохи нижче.

Залишилося тільки привести зображення самого дерева Штерна-Броко (поки ми описывали його з допомогою меняющегося множини). В корені цього нескінченного дерева знаходиться дріб $\frac{1}{1}$, а ліворуч і справа від дерева знаходяться дроби $\frac{0}{1}$ і $\frac{1}{0}$. Будь-Яка вершина дерева має двох синів, кожний з яких виходить як медіанти свого лівого предка і правого предка:

\img{stern_brocot.jpg}

### Доведення

**Упорядоченность**. Вона доводиться дуже просто: зауважимо, що медіанти двох дробів завжди знаходиться між ними, тобто:

$$
\frac{a}{b} \le \frac{a+c}{b+d} \le \frac{c}{d}
$$

при умови, що

$$
\frac{a}{b} \le \frac{c}{d}
$$

Доказывается це просто приведением трьох дробів до загальному знаменателю.

Оскільки на нульовий ітерації упорядоченность мала місце, то вона буде сохраняться і на кожної нової ітерації.

**Несократимость**. Для цього покажемо, що на будь-який ітерації для будь-яких двох сусідніх в списку дробів $\frac{a}{b}$ і $\frac{c}{d}$ виконується:

$$
bc-ad=1
$$

Дійсно, згадуючи [Диофантовы рівняння з двома невідомими ($ax+by=c$)](diofant_2_equation), отримуємо з цього затвердження, що ${\rm gcd}(a,b) = {\rm gcd}(c,d) = 1$, що нам і потрібно.

Отже, нам треба довести истинность затвердження $bc-ad=1$ на будь-який ітерації. Доведемо його також по індукції. На нульовий ітерації це властивість виконувалося (в чому неважко переконатися). Тепер нехай воно було виконано на попередньою ітерації, покажемо, що воно виконано на поточній ітерації. Для цього треба розглянути тройку дробів-сусідів в новому списку:

$$
\frac{a}{b}, \frac{a+c}{b+d}, \frac{c}{d}
$$

Для них умови приймають вид:

$$
b(a+c) - a(b+d) = 1,
$$

$$
c(b+d) - d(a+c) = 1
$$

Однак истинность цих умов очевидна, при умови істинності $bc-ad=1$. Таким чином, дійсно, це властивість виконано і на поточній ітерації, що і потрібно довести.

**Наличие всіх дробів**. Доведення цього властивості тесно пов'язане з алгоритмом знаходження дроби в дереві Штерна-Броко. Враховуючи, що в дереві Штерна-Броко всі дроби впорядковані, отримуємо, що для будь-який вершини дерева в її лівому піддереві знаходяться дроби, менші її, а в правом - великі її. Звідси отримуємо і очевидний алгоритм пошуку який-або дроби в дереві Штерна-Броко: на початку ми знаходимося в корені; порівнюємо нашу дріб з дробом, записанной в поточній вершині: якщо наша дріб менше, то переходимо в ліве піддерево, якщо наша дріб більше - переходимо в праве, а якщо збігається - знайшли дріб, пошук завершён.

Щоб довести, що нескінченне дерево Штерна-Броко містить всі дроби, достатньо показати, що цей алгоритм пошуку дроби завершиться за кінцеве число кроків для будь-який заданої дроби. Цей алгоритм можна розуміти так: у нас є поточний відрізок $\left[ \frac{a}{b}; \frac{c}{d} \right]$, в якому ми шукаємо нашу дріб $\frac{x}{y}$. Cпершу $\frac{a}{b}=\frac{0}{1}$, $\frac{c}{d}=\frac{1}{0}$. На кожному кроці дріб $\frac{x}{y}$ сравнивается з медиантой кінців відрузку, тобто з $\frac{a+c}{b+d}$, і в залежності від цього ми або зупиняємо пошук, або переходимо в ліву або праву частина відрузку. Якщо б алгоритм пошуку дроби працював нескінченно довго, то наступні умови були б виконані на кожної ітерації:

$$
\frac{a}{b} < \frac{x}{y} < \frac{c}{d}
$$

Але їх можна переписать в такому вигляді:

$$
bx-ay \ge 1,
$$

$$
cy-dx \ge 1
$$

(тут использовалось то, що вони целочисленны, тому з $>0$ випливає $\ge 1$)

Значить, умножая перший на $c+d$, а друге - на $a+b$, і складывая їх, отримуємо:

$$
(c+d)(bx-ay) + (a+b)(cy-dx) \ge a+b+c+d
$$

Розкриваючи дужки ліворуч і враховуючи, що $bc-ad=1$ (див. доведення попереднього властивості), остаточно отримуємо:

$$
x+y \ge a+b+c+d
$$

А оскільки на кожної ітерації хоча б одна з змінних $a, b, c, d$ строго зростає, то процес пошуку дроби $\frac{x}{y}$ буде містити не більш $x+y$ ітерацій, що і потрібно довести.

### Алгоритм побудови дерева

Щоб побудувати будь-яке піддерево дерева Штерна-Броко, достатньо знати тільки лівого і правого предків. Cпершу, на першому рівні, лівим предком є $\frac{0}{1}$, а правим - $\frac{1}{0}$. За ним можна обчислити дріб в поточній вершині, а потім запуститися від лівого і правого синів (лівому сыну передав собі в якості правого предка, а правому сыну - в якості лівого предка).

Псевдокод цій процедуры, пытающийся побудувати усе нескінченне дерево:

<!--- TODO: specify code snippet id -->
``` cpp
void build (int a = 0, int b = 1, int c = 1, int d = 0, int level = 1) {
    int x = a+c,  y = b+d;
    ... висновок поточній дроби x/y на рівні дерева level
    build (a, b, x, y, level + 1);
    build (x, y, c, d, level + 1);
}
```

### Алгоритм пошуку дроби

Алгоритм пошуку дроби був вже описаний при доведення того, що дерево Штерна-Броко містить всі дроби, повторимо його тут. Цей алгоритм - фактично алгоритм бінарного пошуку, або алгоритм пошуку заданого значення в бінарному дереві пошуку. Cпершу ми стоїмо в корені дерева. Стоя в поточній вершині, ми порівнюємо нашу дріб з дробом в поточній вершині. Якщо вони збігаються, то процес зупиняємо - ми знайшли дріб в дереві. Інакше, якщо наша дріб менше дроби в поточній вершині, то переходимо в лівого сина, інакше - в правого.

Як було доведено в свойстве про тому, що дерево Штерна-Броко містить всі невід'ємні дроби, при пошуку дроби $\frac{x}{y}$ алгоритм зробить не більш $x+y$ ітерацій.

Наведемо реалізацію, яка повертає шлях до вершини, містить задану дріб $\frac{x}{y}$, возвращая його в вигляді послідовності символів 'L'/'R': якщо поточний символ рівний 'L', то це позначає перехід в дереві в лівого сина, а інакше - в правого (спершу ми стоїмо в корені дерева, тобто в вершині з дробом $\frac{1}{1}$). Насправді, така послідовність символів, существующая і однозначно определяющая будь-яку неотрицательную дріб, називається **системою числення Штерна-Броко**.

<!--- TODO: specify code snippet id -->
``` cpp
string find (int x, int y, int a = 0, int b = 1, int c = 1, int d = 0) {
    int m = a+c,  n = b+d;
    if (x == m && y == n)
        return "";
    if (x * n < y * m)
        return 'L' + find (x, y, a, b, m, n);
    else
        return 'R' + find (x, y, m, n, c, d);
}
```

Иррациональным числах в системі числення Штерна-Броко будуть відповідати нескінченні послідовності символів; якщо відома якась наперёд задана точність, то можна обмежитися деяким префіксом цій нескінченної послідовності. В процесі цього нескінченного пошуку иррациональной дроби в дереві Штерна-Броко алгоритм буде кожний раз знаходити просту дріб (з поступово возрастающими знаменниками), обеспечивающую лучшее наближення цього иррационального числа (це застосування як раз важливо в годинний техніці, і в зв'язку з цим Ахилл Броко і відкрив це дерево).

## Послідовність Фарея

Последовательностью Фарея порядку $n$ називається множину всіх несократимых дробів між 0 і 1, знаменники яких не перевершують $n$, причому дроби впорядковані в порядку зростання.

Ця послідовність названа в честь английского геолога Джона Фарея (John Farey), який попытался в 1816 р. довести, що в ряде Фарея будь-яка дріб є медиантой двох сусідніх. Насколько відомо, його доведення було неверным, а правильное доведення запропонував декілька пізніше Коши (Cauchy). Втім, ще в 1802 р. математик Харос (Haros) в однієї з своїх работ прийшов практично до тим ж результатам.

Последовательности Фарея мають і безліччю собственных цікавих властивостей, однак найбільш очевидна їх **зв'язок з деревом Штерна-Броко**: фактично, послідовність Фарея виходить удалением деяких ветвей з дерева. Або можна говорити, що для отримання послідовності Фарея потрібно взяти множину дробів, получаемое при побудові дерева Штерна-Броко на нескінченної ітерації, і залишити в цим множині тільки дроби зі знаменниками, не переважаючими $n$ і числителями, не переважаючими знаменники.

З алгоритму побудови дерева Штерна-Броко випливає і аналогічний **алгоритм** для послідовностей Фарея. На нульовий ітерації включимо в множину тільки дроби $\frac{0}{1}$ і $\frac{1}{1}$. На кожної наступного ітерації ми між каждыми двома соседним дробями вставляємо їх медианту, якщо її знаменник не перевершує $n$. Рано або пізно в множині перестанут відбуватися які-або зміни, і процес можна зупиняти - ми знайшли шукану послідовність Фарея.

Вычислим **довжину** послідовності Фарея. Послідовність Фарея порядку $n$ містить всі елементи послідовності Фарея порядку $n-1$, а також всі несократимые дроби зі знаменниками, рівними $n$, але це кількість, як відомо, рівне $\phi(n)$. Таким чином, довжина $L_n$ послідовності Фарея порядку $n$ виражається по формулою:

$$
L_n = L_{n-1} + \phi(n)
$$

або, раскрывая рекурсію:

$$
L_n = 1 + \sum_{k=1}^n \phi(k)
$$

## Література

* \book{Роналд Грэхем, Дональд Кнут, Орен Паташник}{Конкретная математика. Основание информатики}{1998}{graham.djvu}
